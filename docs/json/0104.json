{"tag":"document","content":[{"tag":"chapter","content":[{"tag":"text","content":[" Descobrindo o poder das funções"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"label","content":[{"tag":"text","content":["capitulo-funcoes"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"quote","content":[{"tag":"text","content":["\"É melhor termos 100 funções operando em uma estrutura de dados do que 10 funções operando em dez estruturas\""]},{"tag":"text","content":["  -- Alan Perlis, primeiro ganhador do Turing Award"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["O que são funções"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na Matemática, "]},{"tag":"italic","content":[{"tag":"text","content":["uma função é uma relação entre dois conjuntos, onde há uma relação entre cada um de seus elementos"]}]},{"tag":"ref","content":[{"tag":"text","content":["conceito-funcao"]}]},{"tag":"text","content":[". Traduzindo isso para programadores, significa que uma função é uma caixa preta que devolve resultados de acordo com os argumentos, ou parâmetros, passados a ela."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["programação orientada a objetos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para quem está chegando de uma linguagem orientada a objetos, temos classes e objetos como as construções fundamentais. Você pode passar objetos como parâmetros para outros objetos, pode ter objetos que criam objetos, e pode tratar objetos como valores comuns, guardando-os em variáveis se for necessário. Nesse caso, dizemos que objetos são "]},{"tag":"italic","content":[{"tag":"text","content":["cidadãos de primeira classe"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma aplicação criada utilizando Programação Orientada a Objetos é, basicamente, uma rede de pequenos objetos especializados trabalhando juntos para que dados de entrada sejam "]},{"tag":"italic","content":[{"tag":"text","content":["modificados"]}]},{"tag":"text","content":[" até que tenhamos a informação esperada no final."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["programação funcional"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em uma linguagem funcional, como é o caso do Clojure, as funções são as construções fundamentais. Você pode passar funções por parâmetros para outras funções, escrever funções que retornam funções e também pode tratá-las como valores comuns. Por isso dizemos que funções são cidadãs de primeira classe."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em uma aplicação desenvolvida de maneira funcional, temos uma série de funções que "]},{"tag":"italic","content":[{"tag":"text","content":["transformam"]}]},{"tag":"text","content":[" os dados de entrada até que tenhamos a informação que queremos."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["O coração do Clojure"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando um pouco de licença poética, podemos dizer que funções são o coração da linguagem, e esse capítulo é fundamental para que você consiga aproveitar todo o restante do livro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O conteúdo está recheado de códigos em Clojure e em JavaScript, com um pouquinho de Ruby e Java, e comprovadamente você vai conseguir absorver melhor o conhecimento se tentar digitar os exemplos ao mesmo tempo em que for lendo."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Transformando dados"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure você não modifica dados, mas os transforma. Essa diferença sutil nos força a pensar de uma forma diferente à que estamos acostumados ao resolvermos problemas de forma funcional."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["JavaScript"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para calcularmos a soma de 1 a 10 em JavaScript, precisamos criar uma iteração usando a instrução "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[", uma variável de controle que vai guardar o número a ser somado em cada iteração e uma variável contadora, que vai guardar o resultado da soma."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Executando os exemplos"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para executar os exemplos deste capítulo, utilize o console do Chrome ou do Firebug para os códigos escritos em JavaScript, e o REPL para as instruções escritas em Clojure."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Tanto JavaScript quanto Clojure tem um antepassado em comum, chamado Scheme, o que nos permite usar uma linguagem conhecida para ilustrar os exemplos da linguagem que estamos aprendendo."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos demonstrar isso usando JavaScript no código a seguir:"]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"br","content":null},{"tag":"code-text","content":["var soma = 0;"]},{"tag":"br","content":null},{"tag":"code-text","content":["for(var numero = 1; numero < 11; numero++) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  soma = soma + numero;"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null},{"tag":"code-text","content":["console.log(\"Resultado: \", soma);"]},{"tag":"br","content":null},{"tag":"code-text","content":["// Resultado:  55"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que os valores de "]},{"tag":"monospaced","content":[{"tag":"text","content":["numero"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["soma"]}]},{"tag":"text","content":[" foram modificados pelo menos dez vezes até que tivessemos um resultado final. Pelo fato de seus valores "]},{"tag":"italic","content":[{"tag":"text","content":["variarem"]}]},{"tag":"text","content":[" durante a execução do programa, chamamos essas estruturas de "]},{"tag":"italic","content":[{"tag":"text","content":["variáveis"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["imutabilidade"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure não temos o conceito de "]},{"tag":"italic","content":[{"tag":"text","content":["variável"]}]},{"tag":"text","content":[". Como regra, uma vez que um valor seja atribuido, ele não pode mais ser alterado. Essa característica é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["imutabilidade"]}]},{"tag":"text","content":[". No decorrer do livro vamos entender as vantagens de fazermos com que as estruturas de dados sejam imutáveis por padrão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para que possamos calcular a soma dos números inteiros de 1 a 10 em Clojure, vamos precisar de uma lista com os números de 1 a 10, que vamos "]},{"tag":"italic","content":[{"tag":"text","content":["transformar"]}]},{"tag":"text","content":[" em um número, que será a soma que precisamos."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["range"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["range"]}]},{"tag":"text","content":[", que vem na biblioteca padrão do Clojure, que recebe dois parâmetros e retorna uma lista de números inteiros contidos entre o primeiro parâmetro, inclusive, e o menor inteiro anterior ao segundo parâmetro."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Imutabilidade"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Basicamente, um valor imutável é aquele que não pode ser alterado depois de criado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma estrutura imutável é "]},{"tag":"italic","content":[{"tag":"text","content":["thread-safe"]}]},{"tag":"text","content":[", o que significa que pode ser compartilhada entre diferentes processos sem a necessidade de "]},{"tag":"italic","content":[{"tag":"text","content":["locks"]}]},{"tag":"text","content":[" e outros recursos que rapidamente se tornam complicados de gerenciar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A imutabilidade também torna a aplicação menos sujeita a erros, já que sabemos exatamente onde o valor é criado e qual seu ciclo de vida, reduzindo efeitos colaterais causado por modificações indesejadas ou inesperadas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por fim, você pode usar um valor imutável como chave em um "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[" sem medo de ver o "]},{"tag":"italic","content":[{"tag":"text","content":["hashcode"]}]},{"tag":"text","content":[" ser alterado durante a execução da aplicação, o que acaba sendo um erro muito comum nas demais linguagens."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["var"]}]},{"tag":"index","content":[{"tag":"text","content":["def"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos "]},{"tag":"italic","content":[{"tag":"text","content":["atribuir"]}]},{"tag":"text","content":[" essa lista a uma construção chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[", que é criada com a forma especial "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[", que podemos entender por enquanto como uma variável global. Em seguida vamos exibir o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["numeros"]}]},{"tag":"text","content":[" para que você possa ver que cara tem uma lista em Clojure."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["numeros"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (1 2 3 4 5 6 7 8 9 10)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["reduce"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos utilizar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" para calcularmos a somatória dos itens da lista. Essa função recebe dois parâmetros, sendo o primeiro a função que será aplicada e a segunda a lista que será transformada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos utilizar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["+"]}]},{"tag":"text","content":[" para efetuarmos essa soma e nosso código ficará assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(reduce + numeros)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 55"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["+"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O sinal de "]},{"tag":"monospaced","content":[{"tag":"text","content":["+"]}]},{"tag":"text","content":[" é um nome válido de função, simplificando muito a forma como a linguagem é construída. Imagine que, ao invés de tratarmos os sinais aritméticos como se fosse operadores especiais, podemos tratá-los como se fossem funções comuns. Sendo uma função comum, podemos passá-la por parâmetro para outra função, que no nosso caso é "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["reduce"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" pega o primeiro item da lista, "]},{"tag":"italic","content":[{"tag":"text","content":["1"]}]},{"tag":"text","content":[", aplica a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["+"]}]},{"tag":"text","content":[" com o próximo, "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":[". O resultado, "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[" é somado ao próximo item da lista, também o número "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[". O resultado, "]},{"tag":"italic","content":[{"tag":"text","content":["6"]}]},{"tag":"text","content":[" é somado ao próximo item, e assim por diante, até que a lista termine."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Se você conhece Ruby..."]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Ruby existem os métodos "]},{"tag":"monospaced","content":[{"tag":"text","content":["inject"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" para objetos "]},{"tag":"monospaced","content":[{"tag":"text","content":["Enumerable"]}]},{"tag":"text","content":[" que fazem a mesma coisa que o "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" do Clojure."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código em Clojure que apresentamos é o equivalente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["(1..10).reduce(:+)"]}]},{"tag":"text","content":[" em Ruby."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["apply"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Você pode usar também a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["apply"]}]},{"tag":"text","content":[", que também recebe uma função e uma lista como parâmetros, mas transforma todos os itens da lista em argumentos para a função."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nesse caso, escreveríamos "]},{"tag":"monospaced","content":[{"tag":"text","content":["(apply + numeros)"]}]},{"tag":"text","content":[", que internamente será transformado em "]},{"tag":"monospaced","content":[{"tag":"text","content":["(+ 1 2 3 4 5 6 7 8 9 10)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Apesar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["apply"]}]},{"tag":"text","content":[" serem funções que fazem coisas diferentes, o nosso resultado será o mesmo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Compare o código completo, exibido a seguir, com o equivalente em JavaScript que exibimos anteriormente:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println (reduce + numeros))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 55"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["high order function"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando uma função recebe outra como parâmetro, a chamamos de "]},{"tag":"italic","content":[{"tag":"text","content":["High Order Function"]}]},{"tag":"text","content":[" e, apesar do nome pomposo, você vai ver que é algo muito comum quando você utiliza programação funcional."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Caso você queira somar apenas os números pares entre 1 e 10, teríamos que utilizar um "]},{"tag":"monospaced","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[" no nosso código JavaScript:"]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"br","content":null},{"tag":"code-text","content":["var soma = 0;"]},{"tag":"br","content":null},{"tag":"code-text","content":["for(var numero = 1; numero < 11; numero++) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  if(numero % 2 == 0) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    soma = soma + numero;"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null},{"tag":"code-text","content":["console.log(\"Resultado: \", soma);"]},{"tag":"br","content":null},{"tag":"code-text","content":["// Resultado:  30"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["filter"]}]},{"tag":"index","content":[{"tag":"text","content":["predicado"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure existe uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["filter"]}]},{"tag":"text","content":[", que recebe como parâmetros um "]},{"tag":"italic","content":[{"tag":"text","content":["predicado"]}]},{"tag":"text","content":[" e uma lista. Um predicado é uma função que retorna "]},{"tag":"monospaced","content":[{"tag":"text","content":["true"]}]},{"tag":"text","content":[" ou "]},{"tag":"monospaced","content":[{"tag":"text","content":["false"]}]},{"tag":"text","content":[" de acordo com o parâmetro utilizado. A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["filter"]}]},{"tag":"text","content":[" retorna uma nova lista contendo apenas os itens que fizerem o predicado retornar "]},{"tag":"monospaced","content":[{"tag":"text","content":["true"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["even?"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como queremos somar apenas os números pares, vamos utilizar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["even?"]}]},{"tag":"text","content":[", que retorna "]},{"tag":"monospaced","content":[{"tag":"text","content":["true"]}]},{"tag":"text","content":[" caso o parâmetro passado seja um número par."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(filter even? numeros)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (2 4 6 8 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["numeros"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (1 2 3 4 5 6 7 8 9 10)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["filter"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que, mesmo que "]},{"tag":"monospaced","content":[{"tag":"text","content":["filter"]}]},{"tag":"text","content":[" retorne uma lista de números pares, o valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["numeros"]}]},{"tag":"text","content":[" continua inalterado. Quando lidamos com imutabilidade, as funções retornam um novo valor, deixando o valor original intacto."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["reduce"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora que temos nossa lista de números pares, vamos usar o já conhecido "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[" para calcular a somatória dos itens:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (reduce +"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (filter even? numeros)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 30"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Novamente, compare com o código escrito em JavaScript e note a simplicidade da versão em Clojure."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Funções anônimas"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Tanto a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["+"]}]},{"tag":"text","content":[" quanto a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["even?"]}]},{"tag":"text","content":[" fazem parte da biblioteca padrão do Clojure, que nos ajuda a resolver boa parte dos problemas. Mas, e se precisarmos de algo específico, que não existe na biblioteca padrão e em nenhuma biblioteca de terceiros? Nesse caso precisaremos criar nossas próprias funções."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos supor que, ao invés de calcularmos a soma dos números pares entre 1 e 10, precisássemos calcular os múltiplos de 3 dentro dessa faixa de números."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Se for o caso de usarmos essa lógica apenas uma vez, podemos criar uma função anônima para usarmos como predicado e selecionar apenas os múltiplos de 3:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(filter"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fn [num] (= 0 (mod num 3)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["  numeros)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["fn"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma função anônima é definida através da macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":[", recebendo em seguida um vetor com os parâmetros, delimitador por colchetes e, finalmente, a sequência de instruções a serem executadas. Funções anônimas também são chamadas de "]},{"tag":"italic","content":[{"tag":"text","content":["lambdas"]}]},{"tag":"text","content":[" ou "]},{"tag":"italic","content":[{"tag":"text","content":["funções lambda"]}]},{"tag":"text","content":[" em outras linguagens."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure não existe a palavra chave "]},{"tag":"monospaced","content":[{"tag":"text","content":["return"]}]},{"tag":"text","content":[", como acontece no JavaScript, e a função retorna o valor da última expressão avaliada, como acontece em Ruby."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Formas especiais"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nos dialetos LISP, uma "]},{"tag":"italic","content":[{"tag":"text","content":["forma especial"]}]},{"tag":"text","content":[" é uma construção primitiva da linguagem, avaliada de forma diferente das demais pelo compilador. A partir das formas especiais é possível construir macros e funções que formam a biblioteca padrão da linguagem."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["source"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure é possível ver o código fonte de funções e macros através da macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["source"]}]},{"tag":"text","content":[", disponível no namespace "]},{"tag":"monospaced","content":[{"tag":"text","content":["clojure.repl"]}]},{"tag":"text","content":[", mas você não consegue ver o código fonte das formas especiais a menos que olhe o código fonte do compilador."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando utilizamos funções anônimas, é importante que façam o mínimo necessário, para que o nosso código não fique amontoado e difícil de entender."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["#( )"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existe uma forma mais concisa de escrevemos funções anônimas, onde usamos "]},{"tag":"monospaced","content":[{"tag":"text","content":["#( )"]}]},{"tag":"text","content":[" ao invés de "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Reescrevendo nosso código, teríamos:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(filter"]},{"tag":"br","content":null},{"tag":"code-text","content":["  #(= 0 (mod % 3))"]},{"tag":"br","content":null},{"tag":"code-text","content":["  numeros)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que não precisamos definir a lista de parâmetros para a função e podemos utilizá-los através do símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":[" % "]}]},{"tag":"text","content":[" quando temos apenas um parâmetro, ou "]},{"tag":"monospaced","content":[{"tag":"text","content":[" %1 "]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":[" %2 "]}]},{"tag":"text","content":[" e assim por diante quando tivermos mais de um argumento."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["="]}]},{"tag":"index","content":[{"tag":"text","content":["mod"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba também que tanto "]},{"tag":"monospaced","content":[{"tag":"text","content":["="]}]},{"tag":"text","content":[", que compara a igualdade de dois ou mais valores, e "]},{"tag":"monospaced","content":[{"tag":"text","content":["mod"]}]},{"tag":"text","content":[", que retorna o resto de divisão entre dois números, também são funções."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Dando nomes às funções"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Normalmente precisamos usar uma função mais de uma vez, e para isso ela precisa de um nome. Para isso basta criarmos um "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" e atribuir uma função anônima a ele."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para demonstrar isso, vamos criar um código que calcule a soma dos dobros dos números entre 1 e 10."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos criar um "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["dobro"]}]},{"tag":"text","content":[" e atribuir uma função anônima que multiplica o valor recebido por dois:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def dobro (fn [x] (* x 2)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["defn"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Essa forma acaba deixando o código longo demais desnecessariamente. Então foi criada uma forma reduzida "]},{"tag":"monospaced","content":[{"tag":"text","content":["defn"]}]},{"tag":"text","content":[", que deixa a declaração de função mais parecida com o que já estamos habituados:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn dobro [x] (* x 2))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["map"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para transformarmos nossa lista de números de 1 a 10 em uma lista de dobros, vamos utilizar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["map"]}]},{"tag":"text","content":[", que aplica a função que você informar a cada um dos itens da lista, retornando uma nova lista modificada. Vamos passar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["dobro"]}]},{"tag":"text","content":[" e nossa já conhecida lista de números como parâmetro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso código completo ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numeros (range 1 11))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn dobro [x] (* x 2))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(reduce + (map dobro numeros))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Transformando valores"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["As funções "]},{"tag":"monospaced","content":[{"tag":"text","content":["map"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["reduce"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["filter"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["apply"]}]},{"tag":"text","content":[" são, sem dúvida, as mais importantes quando precisamos transformar ou calcular informações em uma linguagem funcional."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Boa parte das funções utilizadas em Clojure usam alguma dessas funções internamente para chegar ao resultado esperado."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Sobrecarga de função e parâmetros opcionais"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso exemplo anterior, criamos uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["dobro"]}]},{"tag":"text","content":[" que recebe um número e retorna seu dobro. Se você tentar executar "]},{"tag":"monospaced","content":[{"tag":"text","content":["dobro"]}]},{"tag":"text","content":[" sem passar parâmetro nenhum, ou se passar mais de um parâmetro, receberemos um erro do compilador."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Chamando dobro sem parâmetros\" label=cap04-dobro-0"]},{"tag":"br","content":null},{"tag":"code-text","content":["(dobro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ArityException Wrong number of args (0) passed to: user$dobro"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E se quisermos escrever uma função que receba vários nomes e nos retorne o que tiver mais letras?"]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["sobrecarga de funções"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos escrever a nossa primeira versão usando "]},{"tag":"italic","content":[{"tag":"text","content":["sobrecarga de funções"]}]},{"tag":"text","content":[". A sobrecarga ocorre quando você tem um mesmo nome de função com diferentes "]},{"tag":"italic","content":[{"tag":"text","content":["assinaturas"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Java"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A assinatura de uma função, em Clojure, é a quantidade de parâmetros que a função recebe. Em Java, a assinatura depende da quantidade de parâmetros e de seus respectivos tipos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por exemplo, nesse código em Java:"]},{"tag":"br","content":null}]},{"tag":"code","content":["java",{"tag":"br","content":null},{"tag":"code-text","content":["public class Sobrecarga {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public void metodo( ) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"Não tenho parâmetros\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public void metodo(String texto) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"Eu recebi uma String\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public void metodo(int numero) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"Eu recebi um numero\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public void metodo(String texto, int numero) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"Eu recebi uma String e um numero\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos usar a própria função "]},{"tag":"monospaced","content":[{"tag":"text","content":["main"]}]},{"tag":"text","content":[" para exibir o resultado:"]},{"tag":"br","content":null}]},{"tag":"code","content":["java",{"tag":"br","content":null},{"tag":"code-text","content":["public void static main(String[] args) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  Sobrecarga objeto = new Sobrecarga();"]},{"tag":"br","content":null},{"tag":"code-text","content":["  objeto.metodo();"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // imprime: Não tenho parãmetros"]},{"tag":"br","content":null},{"tag":"code-text","content":["  objeto.metodo(\"Plínio\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // imprime: Eu recebi uma String"]},{"tag":"br","content":null},{"tag":"code-text","content":["  objeto.metodo(42);"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // imprime: Eu recebi um numero"]},{"tag":"br","content":null},{"tag":"code-text","content":["  objeto.metodo(\"Douglas Adams\", 42);"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // imprime: Eu recebi uma String e um numero"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que foram executados blocos diferentes de código de acordo com o tipo e a quantidade de argumentos."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["aridade"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como não declaramos o tipo do parâmetro de uma função em Clojure, a única coisa que diferencia um bloco de outro é sua "]},{"tag":"italic","content":[{"tag":"text","content":["aridade"]}]},{"tag":"text","content":[". Aridade nada mais é do que a quantidade de parâmetros que uma função recebe."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para utilizar sobrecarga de funções em Clojure, declaramos a função uma única vez, separando os blocos de acordo com suas respectivas aridades."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Colocando a mão na massa, nossa função teria essa cara:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn maior-nome"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ([a]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    a)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ([a b]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (if (> (count a) (count b)) a b)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Não é bonito, mas funcionou bem com um ou dois nomes. E se quisermos colocar três nomes? E com oito nomes?"]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["função variádica"]}]},{"tag":"index","content":[{"tag":"text","content":["&"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Aí entra em cena o conceito de "]},{"tag":"italic","content":[{"tag":"text","content":["função variádica"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["função de aridade variável"]}]},{"tag":"text","content":[". Esses nomes bonitões querem dizer que a função aceita um número variável de argumentos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para isso, basta utilizar o símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":["&"]}]},{"tag":"text","content":[" antes do argumento na declaração da função:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn funcao"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ([]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Não tenho parâmetros\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ([& b]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Tenho um ou mais parâmetros\" b)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E, em seguida, vamos testar a função:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(funcao)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(funcao 1 2 3 4)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso exemplo, quando você usa um ou mais argumentos, "]},{"tag":"monospaced","content":[{"tag":"text","content":["b"]}]},{"tag":"text","content":[" guarda um array contendo os itens que foram passados por parâmetro. A partir daí você pode transformá-los ou "]},{"tag":"italic","content":[{"tag":"text","content":["consumí-los"]}]},{"tag":"text","content":[", conforme a sua necessidade."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Consumindo itens"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Consumir"]}]},{"tag":"text","content":[" uma lista significa que você vai processar o primeiro item e passar o resto da lista por parâmetro para que seja processada novamente, de maneira recursiva."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Mais para frente vamos aprender recursão e você vai perceber que essa é uma estratégia muito comum quando lidamos com estruturas imutáveis."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Voltando à nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["maior-nome"]}]},{"tag":"text","content":[", vamos escrever uma segunda versão de forma mais simples e elegante:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn maior-nome [& nomes]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ; aqui vem o código"]},{"tag":"br","content":null},{"tag":"code-text","content":["  )"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Sabemos que "]},{"tag":"monospaced","content":[{"tag":"text","content":["nomes"]}]},{"tag":"text","content":[" contém uma lista de "]},{"tag":"italic","content":[{"tag":"text","content":["strings"]}]},{"tag":"text","content":[", contendo os nomes que passarmos para a função."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["sort"]}]},{"tag":"index","content":[{"tag":"text","content":["sort-by"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem duas funções para ordenar listas em Clojure: "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort-by"]}]},{"tag":"text","content":[". Vamos criar uma lista chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["lista-nomes"]}]},{"tag":"text","content":[" para simularmos o conteúdo de "]},{"tag":"monospaced","content":[{"tag":"text","content":["nomes"]}]},{"tag":"text","content":[" enquanto não escrevemos o código da função."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro vamos tentar ordenar usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def lista-nomes [\"Plínio\" \"Paulo\" \"Igor\" \"Gustavo\"])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(sort lista-nomes)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (\"Gustavo\" \"Igor\" \"Paulo\" \"Plínio\")"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A lista foi ordenada alfabeticamente, e não pelo tamanho dos nomes. Fica claro que a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort"]}]},{"tag":"text","content":[" não serve para o que queremos."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["count"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort-by"]}]},{"tag":"text","content":[" permite que você informe a função que será usada para ordenar a lista. Vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[", que retorna a quantidade de caracteres em um texto."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(count \"Um texto qualquer\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 17"]},{"tag":"br","content":null},{"tag":"code-text","content":["(sort-by count lista-nomes)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (\"Igor\" \"Paulo\" \"Plínio\" \"Gustavo\")"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora temos a nossa lista ordenada do menor nome, Igor, para o maior nome, Gustavo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para extrairmos o último item da lista, podemos escolher qual estratégia utilizar."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[">"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos informar à função "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort-by"]}]},{"tag":"text","content":[" que devemos ordenar a lista de forma decrescente, passando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":[">"]}]},{"tag":"text","content":[" como parâmetro, ao invés do padrão crescente e então selecionar apenas o primeiro item através da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["first"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":[">"]}]},{"tag":"text","content":[" indica que "]},{"tag":"italic","content":[{"tag":"text","content":["a palavra maior vem antes"]}]},{"tag":"text","content":[", e que a menor vem depois:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(first (sort-by count > lista-nomes))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["last"]}]},{"tag":"index","content":[{"tag":"text","content":["reverse"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos também manter a ordenação crescente e selecionar apenas o último item através da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["last"]}]},{"tag":"text","content":[". Ou também podemos manter a ordenação crescente, utilizar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["reverse"]}]},{"tag":"text","content":[" para inverter a lista e então utilizar "]},{"tag":"monospaced","content":[{"tag":"text","content":["first"]}]},{"tag":"text","content":[" para selecionar o primeiro item."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(last (sort-by count lista-nomes))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(first (reverse (sort-by count lista-nomes)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Escolhendo a primeira estratégia para montar nossa função, nosso código completo ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn maior-nome [& nomes]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (first (sort-by count > nomes)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(maior-nome)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; nil"]},{"tag":"br","content":null},{"tag":"code-text","content":["(maior-nome \"João\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"João\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(maior-nome \"João\" \"Pedro\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Pedro\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(maior-nome \"Plínio\" \"Paulo\" \"Igor\" \"Gustavo\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Gustavo\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora podemos usar quantos nomes quisermos e a função continuará nos trazendo o maior nome."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Documentação"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["doc"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O Clojure fornece uma macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["doc"]}]},{"tag":"text","content":[" que apresenta a documentação da função informada."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn maior-nome [& nomes]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (first (sort-by count > nomes)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(doc maior-nome)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -------------------------"]},{"tag":"br","content":null},{"tag":"code-text","content":["; user/maior-nome"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ([& nomes])"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   nil"]},{"tag":"br","content":null},{"tag":"code-text","content":["(doc +)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -------------------------"]},{"tag":"br","content":null},{"tag":"code-text","content":["; clojure.core/+"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ([] [x] [x y] [x y & more])"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   Returns the sum of nums. (+) returns 0. Does not auto-promote"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   longs, will throw on overflow. See also: +'"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na função que acabamos de criar não existe documentação nenhuma, enquanto a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["+"]}]},{"tag":"text","content":[" tem um breve texto explicativo que, se não ensina a linguagem para quem está tendo o primeiro contato, pelo menos auxilia aquele que tem alguma pequena noção de como utilizar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos adicionar um pequeno texto explicativo à nossa função e vamos testar novamente. Note que a documentação nada mais é do que uma "]},{"tag":"italic","content":[{"tag":"text","content":["string"]}]},{"tag":"text","content":[" na declaração da função."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn maior-nome"]},{"tag":"br","content":null},{"tag":"code-text","content":["  \"Recebe vários nomes e retorna o que tiver a maior"]},{"tag":"br","content":null},{"tag":"code-text","content":["   quantidade de letras. Caso dois nomes tenham o mesmo"]},{"tag":"br","content":null},{"tag":"code-text","content":["   tamanho e sejam os maiores, será retornando apenas"]},{"tag":"br","content":null},{"tag":"code-text","content":["   um. Caso não seja informado nenhum nome, retorna nil.\""]},{"tag":"br","content":null},{"tag":"code-text","content":["  [& nomes]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (first (sort-by count > nomes)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O texto não ficou tão curto assim, mas é suficiente para que qualquer pessoa que entenda português consiga saber para que ela serve e como usar. Ao utilizarmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["doc"]}]},{"tag":"text","content":[" novamente, teremos:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(doc maior-nome)"]},{"tag":"br","content":null},{"tag":"code-text","content":["-------------------------"]},{"tag":"br","content":null},{"tag":"code-text","content":["; user/maior-nome"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ([& nomes])"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   Recebe vários nomes e retorna o que tiver a maior"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   quantidade de letras. Caso dois nomes tenham o mesmo"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   tamanho e sejam os maiores, será retornando apenas"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   um. Caso não seja informado nenhum nome, retorna nil."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Apesar de não ser obrigatório, o uso do texto de documentação sempre deve ser considerado ao desenvolver bibliotecas para terceiros. Existem ferramentas que automatizam a geração de documentação em diversos formatos usando esses textos como base."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Criando escopos locais"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando escrevemos código em JavaScript, usamos a palavra chave "]},{"tag":"monospaced","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" para declarar tanto variáveis locais quando globais. Vamos declarar uma variável chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":[", exibir seu valor antes e depois da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["calculaPreco"]}]},{"tag":"text","content":[". Dentro da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["calculaPreco"]}]},{"tag":"text","content":[" vamos criar outra variável que também vamos chamar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O comportamento esperado é que o valor dentro da função não afete o valor que está do lado de fora. Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-0"]}]},{"tag":"text","content":[" vamos ver isso na prática:"]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"text","content":[" \"Diferentes escopos com JavaScript\" label=cap04-escopo-0"]},{"tag":"br","content":null},{"tag":"code-text","content":["var valor = 10;"]},{"tag":"br","content":null},{"tag":"code-text","content":["function calculaPreco (quantidade) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  var valor = quantidade * 2;"]},{"tag":"br","content":null},{"tag":"code-text","content":["  console.log(\"O valor dentro da função é\", valor);"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null},{"tag":"code-text","content":["console.log(\"O valor antes de calculaPreco é\", valor);"]},{"tag":"br","content":null},{"tag":"code-text","content":["calculaPreco(30);"]},{"tag":"br","content":null},{"tag":"code-text","content":["console.log(\"O valor depois de calculaPreco é\", valor);"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na imagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["escopo-javascript"]}]},{"tag":"text","content":[" podemos ver o resultado:"]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/escopo_javascript.png \"Diferentes escopos com JavaScript\" label=escopo-javascript w=80%"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A mesma coisa acontece quando escrevemos código em Java ou Ruby. Quando declaramos uma variável em uma função com o mesmo nome de uma variável global, ocorre algo chamado "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":[", onde a variável do menor escopo "]},{"tag":"italic","content":[{"tag":"text","content":["esconde"]}]},{"tag":"text","content":[" a variável do escopo maior."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Seguindo essa lógica, podemos pensar que basta usarmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[" dentro da função para que possamos utilizar valores locais, certo?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Errado. Vamos descobrir logo que não é bem assim que a coisa funciona em Clojure."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-1"]}]},{"tag":"text","content":[" vamos usar "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[" para escrever o mesmo código que fizemos anteriormente com JavaScript."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Atribuindo valores com def\" label=cap04-escopo-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def valor 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn calcula-preco [quantidade]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (def valor (* quantidade 2))"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"O valor dentro da função é\" valor))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"O valor antes de calcula-preco é\" valor)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor antes de calcula-preco é 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(calcula-preco 30)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor dentro da função é 60"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"O valor depois de calcula-preco é\" valor)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor depois de calcula-preco é 60"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O valor contido em "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":[" foi alterado globalmente, e não era isso que estávamos esperando."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["def"]}]},{"tag":"index","content":[{"tag":"text","content":["Var"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao utilizarmos a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[" para atribuir um valor a um símbolo, estamos criando uma estrutura chamada "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" para armazenar esse valor. Esse "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" é visível em toda a aplicação e, alguns casos que veremos nos capítulos seguintes, pode ter seu valor modificado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma boa regra para o desenvolvimento de software é manter o valor dentro do menor escopo possível, e isso não é possível utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["let"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["escopo local"]}]},{"tag":"index","content":[{"tag":"text","content":["contexto léxico"]}]},{"tag":"index","content":[{"tag":"text","content":["escopo léxico"]}]},{"tag":"index","content":[{"tag":"text","content":["escopo estático"]}]},{"tag":"index","content":[{"tag":"text","content":["local binding"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure temos uma forma chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" que cria um escopo local, chamado também de "]},{"tag":"italic","content":[{"tag":"text","content":["contexto léxico"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["escopo léxico"]}]},{"tag":"text","content":[" ou "]},{"tag":"italic","content":[{"tag":"text","content":["escopo estático"]}]},{"tag":"text","content":[", e ainda "]},{"tag":"italic","content":[{"tag":"text","content":["atribui valores a símbolos de maneira imutável"]}]},{"tag":"text","content":[". Isso significa que, uma vez que um símbolo receba um valor, algo chamado de atribuição ou "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[", não podemos mais alterá-lo enquanto estivermos dentro daquele escopo."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["O let no JavaScript"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A partir de sua versão 1.7"]},{"tag":"ref","content":[{"tag":"text","content":["let-javascript"]}]},{"tag":"text","content":[", o JavaScript também passou a ter uma palavra chave "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[", que também serve para atribuir valores em escopos locais. Porém, como JavaScript não faz uso de imutabilidade, essa versão de "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" permite que os valores sejam alterados após a atribuição."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[", em sua forma mais simples, recebe como parâmetro um vetor contendo um par de itens para cada atribuição. O primeiro item desse par é o símbolo que vai receber o valor, e o segundo é o valor propriamente dito. Esse símbolo é chamado de "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[", algo como "]},{"tag":"italic","content":[{"tag":"text","content":["atribuição local"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"let em sua forma mais simples\" label=cap04-escopo-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(let [x 5]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"O valor de x é\" x))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor de x é 5"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"Tentando acessar x fora do escopo\" x)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; CompilerException java.lang.RuntimeException:"]},{"tag":"br","content":null},{"tag":"code-text","content":[";  Unable to resolve symbol: x in this context"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-2"]}]},{"tag":"text","content":[" podemos ver que "]},{"tag":"monospaced","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[" só existe dentro do escopo criado pelo "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[". Ao tentarmos acessar "]},{"tag":"monospaced","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[" fora do escopo, recebemos um erro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos reescrever em Clojure o código da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-0"]}]},{"tag":"text","content":[", que fizemos em JavaScript, mas usando escopo local:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Atribuindo valores com escopo local\" label=cap04-escopo-3"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def valor 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn calcula-preco [quantidade]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [valor (* quantidade 2)]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"O valor dentro da função é\" valor)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"O valor antes de calcula-preco é\" valor)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor antes de calcula-preco é 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(calcula-preco 30)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor dentro da função é 60"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"O valor depois de calcula-preco é\" valor)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O valor depois de calcula-preco é 10"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Veja que agora a função não alterou o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" que criamos no início do código. Aqui também ocorre "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":[", permitindo que você crie "]},{"tag":"italic","content":[{"tag":"text","content":["local bindings"]}]},{"tag":"text","content":[" com o mesmo nome dos "]},{"tag":"italic","content":[{"tag":"text","content":["vars"]}]},{"tag":"text","content":[" já existentes na aplicação, como vimos ao criar o "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":[" dentro da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["calcula-preco"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O mesmo pode ser feito ao criarmos um "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[", ou simplesmente "]},{"tag":"italic","content":[{"tag":"text","content":["local"]}]},{"tag":"text","content":[", com o mesmo nome de um dos parâmetros da função. O tal do "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":[" torna isso possível:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Demonstrando shadowing\" label=cap04-escopo-4"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def numero 42)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn demonstra-shadowing [numero]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"No inicio da funcao numero vale\" numero)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [numero 1]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Dentro do let numero vale\" numero))"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"No fim da funcao numero vale\" numero))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"O var numero vale\" numero)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; O var numero vale 42"]},{"tag":"br","content":null},{"tag":"code-text","content":["(demonstra-shadowing 35)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; No inicio da funcao numero vale 35"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Dentro do let numero vale 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; No fim da funcao numero vale 35"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["var"]}]},{"tag":"index","content":[{"tag":"text","content":["#'"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Caso você queira ver o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" mesmo quando ocorre "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":[", você deve utilizar a "]},{"tag":"italic","content":[{"tag":"text","content":["forma qualificada"]}]},{"tag":"text","content":[", informando o "]},{"tag":"italic","content":[{"tag":"text","content":["namespace"]}]},{"tag":"text","content":[" e o nome do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" separados pelo caracter "]},{"tag":"monospaced","content":[{"tag":"text","content":["/"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def numero 42)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"numero vale\" numero)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; numero vale 42"]},{"tag":"br","content":null},{"tag":"code-text","content":["(let [numero 35]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Valor com shadowing\" numero)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Valor sem shadowing\" user/numero))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Valor com shadowing 35"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Valor sem shadowing 42"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Outra característica do "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" é que, pelo fato das atribuições ocorrerem sequencialmente, você pode quebrar seu código em pequenos passos lógicos, tornando-o mais fácil de entender."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Usando let para melhorar o código"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Bhaskara"]}]},{"tag":"index","content":[{"tag":"text","content":["equação quadrática"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A maneira mais conhecida de se resolver equações de segundo grau é através do que chamamos no Brasil de "]},{"tag":"italic","content":[{"tag":"text","content":["fórmula de Bhaskara"]}]},{"tag":"text","content":[", que podemos ver na figura "]},{"tag":"ref-label","content":[{"tag":"text","content":["bhaskara"]}]},{"tag":"text","content":[". Nos demais países ela é conhecida apenas por "]},{"tag":"italic","content":[{"tag":"text","content":["equação quadrática"]}]},{"tag":"text","content":[" ou "]},{"tag":"italic","content":[{"tag":"text","content":["fórmula geral para resolução da equação polinomial do segundo grau"]}]},{"tag":"ref","content":[{"tag":"text","content":["equacao-quadratica"]}]},{"tag":"text","content":[". Para fins de concisão, vamos chamar apenas de "]},{"tag":"italic","content":[{"tag":"text","content":["Bhaskara"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/bhaskara.jpg \"Equação quadrática\" label=bhaskara w=30%"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma equação de segundo grau se apresenta na forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["ax² + bx + c = 0"]}]},{"tag":"text","content":[", sendo "]},{"tag":"monospaced","content":[{"tag":"text","content":["a"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["b"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["c"]}]},{"tag":"text","content":[" valores numéricos sem nada de especial. Esse tipo de equação apresenta dois valores válidos para "]},{"tag":"monospaced","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[", que são chamados de "]},{"tag":"italic","content":[{"tag":"text","content":["raízes"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para encontrar os valores dessas raízes, vamos criar uma função chamada "]},{"tag":"italic","content":[{"tag":"text","content":["bhaskara"]}]},{"tag":"text","content":[", que recebe três parâmetros referentes aos valores de "]},{"tag":"monospaced","content":[{"tag":"text","content":["a"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["b"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["c"]}]},{"tag":"text","content":[" e retorna um vetor de duas posições, contendo as raízes da equação."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-5"]}]},{"tag":"text","content":[", vamos implementar essa função com um código compacto, mas difícil de ler."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Math/sqrt"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Equação quadrática pelo jeito curto e difícil de ler\" label=cap04-escopo-5"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  [(/ (+ (- b) (Math/sqrt (- (* b b) (* 4 a c)))) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["   (/ (- (- b) (Math/sqrt (- (* b b) (* 4 a c)))) (* 2 a))])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0, -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos começar quebrando a equação, calculando o discriminante, ou delta, separadamente. Apesar do delta se referir apenas a "]},{"tag":"monospaced","content":[{"tag":"text","content":["b² - 4ac"]}]},{"tag":"text","content":[", conforme exibido na figura "]},{"tag":"ref-label","content":[{"tag":"text","content":["bhaskara-delta"]}]},{"tag":"text","content":[", vamos incluir também o cálculo de raiz quadrada, para que nosso código fique mais organizado."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/bhaskara_delta.png \"Discriminante, ou delta\" w=30% label=bhaskara-delta"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos separar o discriminante num "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["delta"]}]},{"tag":"text","content":[", e vamos usar o corpo da função para calcular o restante da equação, de acordo com a figura "]},{"tag":"ref-label","content":[{"tag":"text","content":["bhaskara-simplificado"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/bhaskara_simplificado.png \"Equação com o delta separado\" w=30% label=bhaskara-simplificado"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Separando o delta do restante da equação, nosso código ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Equação quadrática com o delta isolado\" label=cap04-escopo-6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [delta (Math/sqrt (- (* b b) (* 4 a c)))]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    [(/ (+ (- b) delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (/ (- (- b) delta) (* 2 a))]))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0, -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos separar também "]},{"tag":"monospaced","content":[{"tag":"text","content":["b²"]}]},{"tag":"text","content":[" como uma parte separada, para deixar o cálculo de "]},{"tag":"monospaced","content":[{"tag":"text","content":["delta"]}]},{"tag":"text","content":[" mais limpo. Podemos fazer o mesmo com "]},{"tag":"monospaced","content":[{"tag":"text","content":["-b"]}]},{"tag":"text","content":[", e até mesmo separar as duas raízes em "]},{"tag":"monospaced","content":[{"tag":"text","content":["x1"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["x2"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso código vai ficar mais extenso, mas os passos lógicos ficam mais claros. A partir deste ponto, fique à vontade para continuar quebrando o código em quantos passos você achar necessário. O tempo e a experiência vão te ensinar a decidir quando escrever código mais detalhado e quando escrever código mais conciso."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Equação quadrática com as partes separadas\" label=cap04-escopo-7"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [b-quadrado (* b b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        menos-b (- b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        delta (Math/sqrt (- b-quadrado (* 4 a c)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x1 (/ (+ menos-b delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x2 (/ (- menos-b delta) (* 2 a))]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    [x1 x2]))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0, -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Um pequeno truque com let"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Enquanto escrevia este capítulo, digitei o código abaixo para demonstrar como um "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[" não pode ser alterado depois de criado:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(let [valor 3"]},{"tag":"br","content":null},{"tag":"code-text","content":["      valor 42]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println valor))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 42"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Era esperado que um erro de execução ocorresse, mas acabou sendo exibido o último valor atribuido."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao pesquisar mais um pouco"]},{"tag":"ref","content":[{"tag":"text","content":["change-let"]}]},{"tag":"text","content":[" descobri que, internamente, a linguagem cria um novo escopo léxico para atribuir "]},{"tag":"italic","content":[{"tag":"text","content":["42"]}]},{"tag":"text","content":[" ao "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Então, na prática, esse código vai ser transformado em:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(let [valor 3]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [valor 42]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println 42)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 42"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A segunda declaração de "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor"]}]},{"tag":"text","content":[" vai fazer shadowing na primeira, fazendo com que o "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[" não possa ser acessado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Então você se pergunta onde é que isso seria usado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existe um macete bem interessante para podermos depurar os valores do "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" passo a passo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":["_"]}]},{"tag":"text","content":[" é um identificador válido em Clojure, mas normalmente é utilizado para indicar que aquele valor não vai ser aproveitado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos utilizar esse símbolo apenas para ocupar espaço enquanto usamos a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["println"]}]},{"tag":"text","content":[" para exibir os valores conforme os "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" vão sendo executados. Vamos aproveitar a listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-7"]}]},{"tag":"text","content":[" para exibir passo a passo o que está acontecendo no nosso cálculo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando usamos um símbolo ou um valor apenas para ocupar espaço, dizemos que ele é um "]},{"tag":"italic","content":[{"tag":"text","content":["placeholder"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Depurando o binding\" label=cap04-escopo-8"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [b-quadrado (* b b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        _ (println \"b² =\" b-quadrado)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        menos-b (- b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        _ (println \"-b =\" menos-b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        delta (Math/sqrt (- b-quadrado (* 4 a c)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        _ (println \"delta =\" delta)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x1 (/ (+ menos-b delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        _ (println \"x1 =\" x1)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x2 (/ (- menos-b delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        _ (println \"x2 =\" x2)]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    [x1 x2]))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; b² = 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -b = 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; delta = 3.0"]},{"tag":"br","content":null},{"tag":"code-text","content":["; x1 = 2.0"]},{"tag":"br","content":null},{"tag":"code-text","content":["; x2 = -1.0"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0 -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Declarando funções locais"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em alguns casos é necessário criar funções que serão usadas apenas dentro daquele escopo local."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos usar novamente o código da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-7"]}]},{"tag":"text","content":[" para demonstrar como podemos fazer isso."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para calcular "]},{"tag":"monospaced","content":[{"tag":"text","content":["delta"]}]},{"tag":"text","content":[", estamos usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["Math/sqrt"]}]},{"tag":"text","content":[", que é o método estático "]},{"tag":"monospaced","content":[{"tag":"text","content":["sqrt"]}]},{"tag":"text","content":[" da classe Java "]},{"tag":"monospaced","content":[{"tag":"text","content":["Math"]}]},{"tag":"text","content":[". Apesar de funcionar muito bem, podemos argumentar que a chamada dessa forma não está com cara de Clojure e bagunça a leitura do código."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar um "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" com o nome de "]},{"tag":"monospaced","content":[{"tag":"text","content":["raiz"]}]},{"tag":"text","content":[", que contém uma função que recebe um parâmetro e calcula a respectiva raiz quadrada usando o método do Java."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Declarando uma função local com binding\" label=cap04-escopo-8"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [raiz (fn [x] (Math/sqrt x))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        b-quadrado (* b b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        menos-b (- b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        delta (raiz (- b-quadrado (* 4 a c)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x1 (/ (+ menos-b delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        x2 (/ (- menos-b delta) (* 2 a))]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    [x1 x2]))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0, -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O nosso cálculo de "]},{"tag":"monospaced","content":[{"tag":"text","content":["delta"]}]},{"tag":"text","content":[" ficou um pouco mais limpo a partir do momento em que escondemos a chamada ao Java dentro de uma função. Uma função que esconde, ou "]},{"tag":"italic","content":[{"tag":"text","content":["empacota"]}]},{"tag":"text","content":[", uma chamada ao Java é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["wrapper"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["É comum na biblioteca padrão do Clojure que se juntem dois operadores para formar um. Vimos isso com a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["defn"]}]},{"tag":"text","content":[", que é a junção de "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[" com "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["letfn"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao invés de usarmos um "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":[" dentro de um "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[", podemos usar a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["letfn"]}]},{"tag":"text","content":[", que internamente opera de modo similar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-escopo-9"]}]},{"tag":"text","content":[", reescrevemos o nosso código usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["letfn"]}]},{"tag":"text","content":[" para separar a declaração de função local dos passos lógicos do nosso código."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Declarando uma função local com letfn\" label=cap04-escopo-9"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn bhaskara [a b c]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (letfn [(raiz [x] (Math/sqrt x))]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (let [b-quadrado (* b b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["          menos-b (- b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["          delta (raiz (- b-quadrado (* 4 a c)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["          x1 (/ (+ menos-b delta) (* 2 a))"]},{"tag":"br","content":null},{"tag":"code-text","content":["          x2 (/ (- menos-b delta) (* 2 a))]"]},{"tag":"br","content":null},{"tag":"code-text","content":["      [x1 x2])))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bhaskara 1 -1 -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [2.0, -1.0]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que a sintaxe de "]},{"tag":"monospaced","content":[{"tag":"text","content":["letfn"]}]},{"tag":"text","content":[" é uma mistura de "]},{"tag":"monospaced","content":[{"tag":"text","content":["defn"]}]},{"tag":"text","content":[" com "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[", onde você precisa informar o nome, a lista de argumentos e o corpo da função dentro de um vetor."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["escopo global"]}]},{"tag":"index","content":[{"tag":"text","content":["escopo léxico"]}]},{"tag":"index","content":[{"tag":"text","content":["escopo dinâmico"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Escopos global, léxico e dinâmico"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O escopo que conhecemos de linguagens como C, Java, Ruby e várias outras e usamos praticamente o tempo todo com "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" ou dentro de funções é o "]},{"tag":"italic","content":[{"tag":"text","content":["escopo léxico"]}]},{"tag":"text","content":[", como vimos há pouco."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nesse tipo de escopo uma informação existe apenas num intervalo específico de código."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure, ao criarmos um escopo dentro de outro e atribuirmos valores a um mesmo símbolo declarado em cada um desses escopos, o símbolo do escopo mais interno vai esconder o valor referenciado pelo símbolo do escopo imediatamente menos interno. Isso é chamado "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":[", como também vimos neste capítulo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dica: quando executar os códigos a seguir, não precisa digitar os números de linha. Coloquei-os aqui apenas para facilitar a explicação na sequencia."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def lexico :batata)                                ;  1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"Antes do let:\" lexico)                    ;  2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Antes do let: :batata"]},{"tag":"br","content":null},{"tag":"code-text","content":["(let [lexico :abobora]                              ;  3"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Dentro do escopo local\" lexico)         ;  4"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [lexico :feijao]                             ;  5"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Escopo local mais interno\" lexico))   ;  6"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Escopo local menos interno\" lexico))    ;  7"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Dentro do escopo local :abobora"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Escopo local mais interno :feijao"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Escopo local menos interno :abobora"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"Fora do escopo local\"  lexico)            ;  8"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Fora do escopo local :batata"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na linha "]},{"tag":"italic","content":[{"tag":"text","content":["1"]}]},{"tag":"text","content":[" definimos um "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["lexico"]}]},{"tag":"text","content":[" e exibimos seu valor na linha "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já na linha "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[" criamos um "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[" com o mesmo nome do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" e atribuimos outro valor, exibido na linha "]},{"tag":"italic","content":[{"tag":"text","content":["4"]}]},{"tag":"text","content":[". Na linha "]},{"tag":"italic","content":[{"tag":"text","content":["5"]}]},{"tag":"text","content":[" criamos outro escopo dentro do escopo existente e atribuimos ainda outro valor. Esse valor do escopo mais interno esconde o valor do escopo imediatamente acima, que já estava escondendo o valor do escopo mais amplo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já o "]},{"tag":"italic","content":[{"tag":"text","content":["escopo global"]}]},{"tag":"text","content":[" é uma aplicação do escopo léxico que pode nos trazer incontáveis dores de cabeça. É quando temos um valor pode ser acessado de qualquer parte do sistema."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Se o valor puder apenas ser acessado, não há tanto problema. A coisa fica feia quando qualquer parte do sistema pode "]},{"tag":"italic","content":[{"tag":"text","content":["acessar e modificar"]}]},{"tag":"text","content":[" o valor. Isso pode nos levar a inconsistências e comportamentos inesperados."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos ver um dos problemas em utilizar dados no escopo global."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def global :carvao)                                ;  1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"Estado global:\" global)                   ;  2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Estado global: :carvao"]},{"tag":"br","content":null},{"tag":"code-text","content":["(let [lexico :carne]                                ;  3"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Dentro do escopo local\" lexico)         ;  4"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (def global :cerveja)                             ;  5"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Dentro do escopo local\" lexico))        ;  6"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Dentro do escopo local :carne"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Dentro do escopo local :carne"]},{"tag":"br","content":null},{"tag":"code-text","content":["(println \"Depois do escopo local:\"  global)         ; 7"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Depois do escopo local: :cerveja"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na linha "]},{"tag":"italic","content":[{"tag":"text","content":["1"]}]},{"tag":"text","content":[" nós criamos o "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["global"]}]},{"tag":"text","content":[" e atribuimos um valor, exibindo-o na linha "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já na linha "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[" criamos um "]},{"tag":"italic","content":[{"tag":"text","content":["local binding"]}]},{"tag":"text","content":[" com o mesmo nome, demonstrando na linha "]},{"tag":"italic","content":[{"tag":"text","content":["4"]}]},{"tag":"text","content":[" que o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" foi escondido pelo "]},{"tag":"italic","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[". Porém, na linha "]},{"tag":"italic","content":[{"tag":"text","content":["5"]}]},{"tag":"text","content":[" criamos um novo "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[", atribuindo o valor "]},{"tag":"monospaced","content":[{"tag":"text","content":[":cerveja"]}]},{"tag":"text","content":[". Note que na linha "]},{"tag":"italic","content":[{"tag":"text","content":["6"]}]},{"tag":"text","content":[" não vemos nenhuma mudança no valor por conta do "]},{"tag":"italic","content":[{"tag":"text","content":["shadowing"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já na linha "]},{"tag":"italic","content":[{"tag":"text","content":["7"]}]},{"tag":"text","content":[" o valor aparece modificado. Como o valor exibido dentro do "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" não apresenta diferença, a tentdência é que passemos direto ao tentarmos encontrar a causa do problema."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A situação fica ainda pior quando trabalhamos com várias "]},{"tag":"italic","content":[{"tag":"text","content":["threads"]}]},{"tag":"text","content":[", por uma "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" pode alterar o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" e isso acaba se refletindo nas outras "]},{"tag":"italic","content":[{"tag":"text","content":["threads"]}]},{"tag":"text","content":[". Para piorar ainda mais, o problema pode ou não ocorrer quando você tentar reproduzí-lo, já que não existe garantias de que "]},{"tag":"italic","content":[{"tag":"text","content":["threads"]}]},{"tag":"text","content":[" diferentes serão sempre executadas na mesma ordem e exatamente no mesmo intervalo de tempo."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Escopo dinâmico"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["binding (macro)"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já o "]},{"tag":"italic","content":[{"tag":"text","content":["escopo dinâmico"]}]},{"tag":"text","content":[" funciona como o "]},{"tag":"italic","content":[{"tag":"text","content":["escopo global"]}]},{"tag":"text","content":[", mas o valor fica restrito às chamadas delimitadas pela macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" e pela "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" em que a chamada a "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" ocorre."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["^:dynamic"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para usarmos escopo dinâmico, precisamos adicionar a anotação "]},{"tag":"monospaced","content":[{"tag":"text","content":["^:dynamic"]}]},{"tag":"text","content":[" no "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" que vamos criar."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ^:dynamic *parte* \"cabeça\")"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Cuidado com textos desatualizados"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Até a versão "]},{"tag":"monospaced","content":[{"tag":"text","content":["1.2"]}]},{"tag":"text","content":[" do Clojure todo "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" era dinâmico por padrão. Da versão "]},{"tag":"monospaced","content":[{"tag":"text","content":["1.3"]}]},{"tag":"text","content":[" em diante passou a ser obrigatório anotar o "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" com "]},{"tag":"monospaced","content":[{"tag":"text","content":["^:dynamic"]}]},{"tag":"text","content":[". Sabendo disso, tome cuidado com textos e documentação desatualizada que ainda pode ser encontrada facilmente na Internet."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["earmuffins"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Note os asteriscos ao redor do nome do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[". Eles são chamados "]},{"tag":"italic","content":[{"tag":"text","content":["earmuffins"]}]},{"tag":"text","content":[" e servem para sinalizar a quem lê o código que estamos lidando com "]},{"tag":"italic","content":[{"tag":"text","content":["vars"]}]},{"tag":"text","content":[" dinâmicos. Para o Clojure não faz diferença se você não utilizar os "]},{"tag":"italic","content":[{"tag":"text","content":["earmuffins"]}]},{"tag":"text","content":[", mas é uma boa prática adotada pela comunidade."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar agora uma função que exibe o nome do nosso "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" dinâmico."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn mostra-binding [onde]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println onde \"-\" *parte*))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostra-binding \"antes do binding\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; antes do binding - cabeça"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["root binding"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Até aqui não há diferença alguma. A função exibiria o valor que demos na definição do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" sendo dinâmica ou não. Aliás, essa atribuição de valor na criação do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" chama-se "]},{"tag":"italic","content":[{"tag":"text","content":["root binding"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos agora definir um novo valor para "]},{"tag":"monospaced","content":[{"tag":"text","content":["*parte*"]}]},{"tag":"text","content":[" através da macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" e ver o que se passa dentro da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["mostra-binding"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(binding [*parte* \"perna\"]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (mostra-binding \"dentro do binding\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; dentro do binding - perna"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostra-binding \"depois do binding\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; depois do binding - cabeca"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que o valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["*parte*"]}]},{"tag":"text","content":[" mudou apenas no escopo de "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[", inclusive dentro da função."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O escopo dinâmico funciona como um escopo global controlado, em que podemos delimitar quem vai visualizar o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma característica importante do escopo dinâmico é que o valor que definirmos na macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[" fica restrito apenas à "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" em que ele foi definido. Qualquer "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" diferente vai enxergar apenas o valor do "]},{"tag":"italic","content":[{"tag":"text","content":["root binding"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para demonstrar isso, vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["start-thread"]}]},{"tag":"text","content":[", que recebe uma função como parâmetro e a executa em uma "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" diferente da atual."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn start-thread [fun]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (.start (Thread. fun)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos executar novamente nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["mostra-binding"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ^:dynamic *parte* \"cabeça\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostra-binding \"antes do binding\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; antes do binding - cabeça"]},{"tag":"br","content":null},{"tag":"code-text","content":["(binding [*parte* \"perna\"]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"dentro do binding -\" *parte*)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (start-thread #(mostra-binding \"dentro da thread\")))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; dentro do binding - perna"]},{"tag":"br","content":null},{"tag":"code-text","content":["; dentro da thread - cabeça"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostra-binding \"depois do binding\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; depois do binding - cabeça"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Mesmo dentro do "]},{"tag":"monospaced","content":[{"tag":"text","content":["binding"]}]},{"tag":"text","content":[", o código que foi executado em outra "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" não utilizou o valor "]},{"tag":"italic","content":[{"tag":"text","content":["perna"]}]},{"tag":"text","content":[", e sim o valor definido lá no "]},{"tag":"italic","content":[{"tag":"text","content":["root binding"]}]},{"tag":"text","content":[". Isso nos ajuda a escrever código isolado por "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[", ou seja, cada "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" enxerga seus próprios dados sem atrapalhar alguma "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" que esteja sendo executada ao mesmo tempo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Esse tipo de escopo é muito utilizado para trabalharmos com recursos externos separados por "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[", como por exemplo conexões de rede."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos utilizar também para testarmos recursos utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["mock"]}]},{"tag":"text","content":[", ou seja, passamos uma função ou um objeto falso e nosso código o trata como se fosse verdadeiro. Isso ajuda a testar nosso código sem a necessidade de ter um banco de dados ou uma estrutura de rede disponível."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["println"]}]},{"tag":"index","content":[{"tag":"text","content":["*out*"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma função que usamos o tempo todo e faz uso de escopo local é "]},{"tag":"monospaced","content":[{"tag":"text","content":["println"]}]},{"tag":"text","content":[", que faz uso do "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" dinâmico "]},{"tag":"monospaced","content":[{"tag":"text","content":["*out*"]}]},{"tag":"text","content":[". Isso significa que podemos fazer com que "]},{"tag":"monospaced","content":[{"tag":"text","content":["println"]}]},{"tag":"text","content":[" direcione o que deveria ser impresso na tela para um arquivo em disco ou para uma conexão de rede."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos brincar com isso."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro vamos precisar daquela nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["start-thread"]}]},{"tag":"text","content":[". Uma "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[" vai imprimir na tela enquanto a outra vai gravar em disco."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn start-thread [fun]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (.start (Thread. fun)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos agora criar uma função que tanto grava em disco as informações que mandarmos imprimir, quanto imprime na tela, dependendo do que definirmos como "]},{"tag":"monospaced","content":[{"tag":"text","content":["*out*"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn imprime []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Linha 1\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Linha 2\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Ultima linha\"))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos executar a mesma função em duas "]},{"tag":"italic","content":[{"tag":"text","content":["threads"]}]},{"tag":"text","content":[" diferentes, ao mesmo tempo."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["java.io.Writer"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["*out*"]}]},{"tag":"text","content":[" aponta para um objeto Java que implementa "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.io.Writer"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["type"]}]},{"tag":"index","content":[{"tag":"text","content":["java.io.PrintWriter"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(type *out*)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; java.io.PrintWriter"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["java.io.FileWriter"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A classe "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.io.PrintWriter"]}]},{"tag":"text","content":[" é a responsável pela exibição dos dados na tela. Vamos implementar um objeto do tipo "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.io.FileWriter"]}]},{"tag":"text","content":[" para que possamos gravar em disco."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(start-thread (fn []"]},{"tag":"br","content":null},{"tag":"code-text","content":["                (println \"Esse vai na tela\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["                (imprime)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(start-thread (fn []"]},{"tag":"br","content":null},{"tag":"code-text","content":["                (binding [*out* (java.io.FileWriter. \"print.txt\")]"]},{"tag":"br","content":null},{"tag":"code-text","content":["                  (println \"Esse vai no arquivo\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["                  (imprime))))"]},{"tag":"br","content":null},{"tag":"code-text","content":[";; pausa"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Linha 1"]},{"tag":"br","content":null},{"tag":"code-text","content":[";; pausa"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Linha 2"]},{"tag":"br","content":null},{"tag":"code-text","content":[";; pausa"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ultima linha"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["slurp"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos exibir o que gravamos em disco usando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["slurp"]}]},{"tag":"text","content":[", que lê o conteúdo de um arquivo texto e o retorna."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(println (slurp \"print.txt\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Esse vai no arquivo"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Linha 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Linha 2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ultima linha"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dessa forma podemos mudar o comportamento de funções que não podemos alterar, como é o caso de "]},{"tag":"monospaced","content":[{"tag":"text","content":["println"]}]},{"tag":"text","content":[", tornando o código mais flexível e dinâmico."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Contratos e condições"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Contratos"]}]},{"tag":"text","content":[", do original em inglês "]},{"tag":"italic","content":[{"tag":"text","content":["Design by Contract"]}]},{"tag":"text","content":[", é uma forma de verificação dos argumentos recebidos pela função, chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["pré-condição"]}]},{"tag":"text","content":[", e também do resultado da mesma função, que chamamos de "]},{"tag":"italic","content":[{"tag":"text","content":["pós-condições"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Invariantes"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Invariantes"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando uma condição é verdadeira do momento em que a função começa até o momento em que termina, dizemos que é uma "]},{"tag":"italic","content":[{"tag":"text","content":["invariante"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O uso de contratos, através de pré-condições e pós-condições, é uma forma de garantir que as invariantes não assumam valores inesperados que podem causar erros de execução."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma pré-condição permite que você verifique se os parâmetros atendem a uma ou mais condições antes mesmo que a função comece a ser executada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um exemplo de pré-condição pode ser encontrado na forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[". Se você tentar usar "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" sem que o primeiro argumento seja um vetor, e sem que esse vetor contenha um número par de argumentos, será lançada uma exceção antes que qualquer atribuição seja feita."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um caso em que podemos utilizar pré-condições é do cálculo do fatorial de um número. Sabemos que o parâmetro deve ser positivo e inteiro."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Cálculo de fatorial\" label=cap04-contrato-0"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn fatorial [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if (< n 2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      1"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (* n (fatorial (dec n)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3.5)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 8.75"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No código da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-contrato-0"]}]},{"tag":"text","content":[", a função retorna 1 para qualquer valor abaixo de 2, incluindo números negativos."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Fazendo do jeito feio"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["cond"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para limitarmos os valores, podemos adicionar uma verificação antes do nosso código atual para, em seguida, lançarmos uma exceção. Vamos usar a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["cond"]}]},{"tag":"text","content":[" que, de certa forma, é o equivalente ao "]},{"tag":"monospaced","content":[{"tag":"text","content":["else if"]}]},{"tag":"text","content":[" que já estamos acostumados. Com isso teríamos:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Fatorial com checagem de número positivo\" label=cap04-contrato-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(import '(java.lang AssertionError))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn fatorial [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (cond (< n 0) (throw (AssertionError.))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        (< n 2)  1"]},{"tag":"br","content":null},{"tag":"code-text","content":["        :else (* n (fatorial (dec n)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["import"]}]},{"tag":"index","content":[{"tag":"text","content":["java.lang.AssertionError"]}]},{"tag":"index","content":[{"tag":"text","content":["throw"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na primeira linha tivemos que importar a classe "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.lang.AssertionError"]}]},{"tag":"text","content":[", para poder lançar uma exceção desse tipo através da forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["throw"]}]},{"tag":"text","content":[". O ponto final após o nome da classe é a forma do Clojure criar um novo objeto utilizando uma classe Java. Veremos mais detalhes sobre a integração com Java mais para frente, no capítulo "]},{"tag":"ref-label","content":[{"tag":"text","content":["capitulo-integracao-java"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["or"]}]},{"tag":"index","content":[{"tag":"text","content":["integer?"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em seguida precisaremos verificar se o número é inteiro. Para isso vamos adicionar um "]},{"tag":"monospaced","content":[{"tag":"text","content":["or"]}]},{"tag":"text","content":[" na primeira condição e verificar o valor através da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["integer?"]}]},{"tag":"text","content":[", que retorna "]},{"tag":"monospaced","content":[{"tag":"text","content":["true"]}]},{"tag":"text","content":[" caso o número seja inteiro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora, se o parâmetro "]},{"tag":"monospaced","content":[{"tag":"text","content":["n"]}]},{"tag":"text","content":[" for menor que zero "]},{"tag":"italic","content":[{"tag":"text","content":["ou"]}]},{"tag":"text","content":[" não for um valor inteiro, lançaremos uma exceção."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Checagens de número inteiro e positivo\" label=cap04-contrato-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(import '(java.lang AssertionError))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn fatorial [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (cond (or (< n 0)"]},{"tag":"br","content":null},{"tag":"code-text","content":["            (not (integer? n))) (throw (AssertionError.))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        (< n 2)  1"]},{"tag":"br","content":null},{"tag":"code-text","content":["        :else (* n (fatorial (dec n)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3.5)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso código funciona, mas está misturando o cálculo do número fatorial com a verificação dos dados. Deveria ter uma forma de deixarmos o código limpo como na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-contrato-0"]}]},{"tag":"text","content":[", mas verificando se o parâmetro obedece às pré-condições necessárias."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Fazendo do jeito Clojure"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Estamos misturando também classes Java com Clojure, o que poder tornar o código mais verboso e difícil de ler. Além disso, imagine ter que adicionar uma condição extra dentro do seu código toda vez que precisar usar uma pré-condição."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["É aí que entram as pré-condições, separando as checagens em um espaço só para elas, e o código em outro, como sempre foi."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso código, vamos adicionar um mapa contendo a chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":pre"]}]},{"tag":"text","content":[" antes de começarmos a escrever o código da função. Dentro de "]},{"tag":"monospaced","content":[{"tag":"text","content":[":pre"]}]},{"tag":"text","content":[" vamos adicionar um vetor contendo as condições a serem verificadas antes mesmo da função ser executada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O corpo da função só será executado se todas as condições desse vetor forem verdadeiras."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Checagens com pré-condições\" label=cap04-contrato-3"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn fatorial [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  {:pre [(> n 0) (integer? n)]}"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if (< n 2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      1"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (* n (fatorial (dec n)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial -2)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError Assert failed: (> n 0)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatorial 3.5)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError Assert failed: (integer? n)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Além de não precisamos importar nenhuma classe do Java para fazer as checagens, nosso código ficou mais limpo e simples de entender."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["E as pós-condições?"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já as pós-condições verificam se o resultado da função está de acordo com as condições informadas. Elas são bem menos utilizadas do que as pré-condições, uma vez que a invariante deve garantir que nosso resultado está de acordo com o esperado. Porém, se nossa função depende de outra para fazer o que precisamos, não podemos garantir que o resultado sairá sempre dentro do esperado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos imaginar que estamos escrevendo uma aplicação para um site de jogos de cartas online."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nessa aplicação vamos precisar de um função responsável por embaralhar as cartas de um maço de cartas qualquer."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos escrever uma função que receba um vetor contendo as cartas do baralho e uma outra função que contém o algoritmo de embaralhamento das cartas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Os responsáveis pelo site levam tão a sério a tarefa de se ter cartas bem embaralhadas que deixaram esse algoritmo a cargo de uma outra empresa formada por diversos ganhadores de prêmios internacionais de matemática."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos apenas nos preocupar apenas com a função que recebe o baralho e a função criada por terceiros, e vamos garantir que essa função externa não faça nenhuma besteira, como por exemplo repetir cartas ou sumir com elas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Aí você pergunta: \"mas não seria mais fácil a própria função de terceiros verificar se o baralho que entra é o mesmo que sai, só que embaralhado?\". Sim, seria. Mas aí eu não conseguiria explicar pós-condições de uma forma interessante."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro vamos declarar os quatro naipes do baralho e os treze valores para as cartas:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def naipes [:ouros :copas :paus :espadas])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def valores [:A :2 :3 :4 :5 :6 :7 :8 :9 :10 :J :Q :K])"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["for"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em seguida vamos usar a forma  "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[" para gerar todas as combinações possíveis entre "]},{"tag":"monospaced","content":[{"tag":"text","content":["naipes"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["valores"]}]},{"tag":"text","content":[". Vamos discutir o "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[" com mais detalhes no capítulo sobre "]},{"tag":"italic","content":[{"tag":"text","content":["lazy evaluation"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O que precisamos saber aqui é que "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[" vai receber cada item de "]},{"tag":"monospaced","content":[{"tag":"text","content":["naipes"]}]},{"tag":"text","content":[" a atribuir a "]},{"tag":"monospaced","content":[{"tag":"text","content":["n"]}]},{"tag":"text","content":[", fazendo o mesmo com "]},{"tag":"monospaced","content":[{"tag":"text","content":["valores"]}]},{"tag":"text","content":[" e atribuindo cada um dos itens a "]},{"tag":"monospaced","content":[{"tag":"text","content":["v"]}]},{"tag":"text","content":[". Com "]},{"tag":"monospaced","content":[{"tag":"text","content":["n"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["v"]}]},{"tag":"text","content":[" em mãos, vamos devolver um vetor contendo os dois valores. No final do processo teremos uma lista contendo todas as combinações possíveis para cartas de baralho. Vamos usar também a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort"]}]},{"tag":"text","content":[" para fornecermos um maço ordenado alfabeticamente para a função."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def baralho (sort (for [n naipes"]},{"tag":"br","content":null},{"tag":"code-text","content":["                         v valores]"]},{"tag":"br","content":null},{"tag":"code-text","content":["                     [n v])))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos exibir o conteúdo de "]},{"tag":"monospaced","content":[{"tag":"text","content":["baralho"]}]},{"tag":"text","content":[" para vermos o que o "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[" retornou:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["baralho"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ([:copas :10] [:copas :2] [:copas :3] [:copas :4] [:copas :5]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:copas :6] [:copas :7] [:copas :8] [:copas :9] [:copas :A]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:copas :J] [:copas :K] [:copas :Q] [:espadas :10] [:espadas :2]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:espadas :3] [:espadas :4] [:espadas :5] [:espadas :6]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:espadas :7] [:espadas :8] [:espadas :9] [:espadas :A]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:espadas :J] [:espadas :K] [:espadas :Q] [:ouros :10]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:ouros :2] [:ouros :3] [:ouros :4] [:ouros :5] [:ouros :6]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:ouros :7]  [:ouros :8] [:ouros :9][:ouros :A] [:ouros :J]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:ouros :K] [:ouros :Q] [:paus :10] [:paus :2] [:paus :3]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:paus :4] [:paus :5] [:paus :6] [:paus :7] [:paus :8] [:paus :9]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:paus :A] [:paus :J] [:paus :K] [:paus :Q])"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["embaralha"]}]},{"tag":"text","content":[", que recebe como parâmetros a função criada por qualquer outra pessoa e a lista contendo as cartas ."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn embaralha [fun baralho]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fun baralho))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vemos que a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["embaralha"]}]},{"tag":"text","content":[" não faz nada de especial. Apenas executa a função contida em "]},{"tag":"monospaced","content":[{"tag":"text","content":["fun"]}]},{"tag":"text","content":[" usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["baralho"]}]},{"tag":"text","content":[" como argumento."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem duas regras que devemos verificar antes de entregar o resultado da função: o maço embaralhado deve conter exatamente as mesmas cartas que o maço inicial, e após o processo de embaralhamento o maço não pode estar ordenado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao usarmos pós-condições, o resultado da função é atribuído ao símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":[" % "]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para sabermos se o maço inicial contém as mesmas cartas do maço final, basta retirarmos todos os itens repetidos usando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["distinct"]}]},{"tag":"text","content":[" e depois ordenar usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["sort"]}]},{"tag":"text","content":[". No maço de entrada temos certeza de que não existem itens repetidos, mas não podemos ter a mesma certeza a respeito do retorno da função contida em "]},{"tag":"monospaced","content":[{"tag":"text","content":["fun"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossa primeira condição então pode ser escrita como "]},{"tag":"monospaced","content":[{"tag":"text","content":["(= baralho (sort (distinct %)))"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["not="]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Seguindo a segunda condição, o baralho devolvido pela função não pode estar ordenado. Para isso basta verificarmos se "]},{"tag":"monospaced","content":[{"tag":"text","content":["baralho"]}]},{"tag":"text","content":[" não é igual ao retorno da função, escrevendo a condição "]},{"tag":"monospaced","content":[{"tag":"text","content":["(not= baralho %)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Adicionando essas duas pós-condições na função, teremos nosso código completo na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-contrato-4"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Função embaralha com pós-condições\" label=cap04-contrato-4"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def naipes [:ouros :copas :paus :espadas])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def valores [:A :2 :3 :4 :5 :6 :7 :8 :9 :10 :J :Q :K])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def baralho (sort (for [n naipes"]},{"tag":"br","content":null},{"tag":"code-text","content":["                         v valores]"]},{"tag":"br","content":null},{"tag":"code-text","content":["                     [n v])))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn embaralha [fun baralho]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  {:post [(= baralho (sort (distinct %)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["          (not= baralho %)]}"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fun baralho))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos testar se nossa função está fazendo as verificações corretamente e, para isso, vamos criar duas funções. A primeira, que vamos chamar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["mesma-carta"]}]},{"tag":"text","content":[" recebe um maço e devolve outro com o mesmo tamanho, mas com apenas uma carta repetidamente. Vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["map"]}]},{"tag":"text","content":[" para substituir todas as cartas por um ás de espadas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A segunda função, que vamos chamar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["faz-nada"]}]},{"tag":"text","content":[", também recebe um maço e o devolve sem alterações. Com isso poderemos testar se as duas condições estão sendo verificadas corretamente."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Testando as pós-condições\" label=cap04-contrato-5"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn mesma-carta [baralho]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (map (fn [carta] [:as :espadas]) baralho))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn faz-nada [baralho]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  baralho)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(embaralha mesma-carta baralho)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError Assert failed: (= baralho (sort (distinct %)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(embaralha faz-nada baralho)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; AssertionError Assert failed: (not= baralho %)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["shuffle"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossas pós-condições estão funcionando corretamente. Mas e como fazemos para testar se a função está fazendo o que queremos? Para isso vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["shuffle"]}]},{"tag":"text","content":[", do próprio Clojure, que recebe uma sequência como parâmetro e a devolve embaralhada. Exatamente o que queríamos lá no início do exemplo."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(embaralha shuffle baralho)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [[:espadas :A] [:paus :J] [:copas :4] [:espadas :4] [:ouros :6]"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ...mais cartas..."]},{"tag":"br","content":null},{"tag":"code-text","content":["; [:copas :K] [:espadas :5] [:espadas :2]]"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como vimos, contratos são úteis para verificarmos se as condições necessárias para a execução do nosso código estão sendo atendidas e se o retorno está dentro do que esperamos."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Destructuring"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Destructuring"]}]},{"tag":"text","content":[" é uma forma de decompor uma estrutura em uma atribuição, permitindo que você utilize somente as informações que forem relevantes."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Você pode usar "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" ao declarar a lista de argumentos de uma função ou durante as atribuições de um escopo local. É possível usar "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" também em macros que se baseiem em "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":[" ou "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Qual a tradução de "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":["?"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O termo "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" não tem uma boa tradução para o nosso contexto. Ao pé da letra, pode ser traduzido por \""]},{"tag":"italic","content":[{"tag":"text","content":["desestruturação"]}]},{"tag":"text","content":["\", mas o termo em português pode levar a uma compreensão errada. Podemos entender "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" como uma "]},{"tag":"italic","content":[{"tag":"text","content":["desmontagem"]}]},{"tag":"text","content":[" da coleção que foi usada como argumento."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como atualmente quase toda a literatura sobre Clojure está em inglês, vamos nos ater ao termo original e evitar uma tradução forçada e incorreta."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem duas formas de trabalhar com "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[": "]},{"tag":"italic","content":[{"tag":"text","content":["vector destructuring"]}]},{"tag":"text","content":[" e "]},{"tag":"italic","content":[{"tag":"text","content":["map destructuring"]}]},{"tag":"text","content":[". As duas formas cobrem boa parte das estruturas de dados mais comuns na linguagem: listas, arrays e mapas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Não se preocupe em entender as diferenças entre listas e arrays nesse momento. Entraremos em detalhes sobre essas estruturas no próximo capítulo."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Vector destructuring"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["destructuring, vector"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O caso mais simples de "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" envolve o uso de "]},{"tag":"italic","content":[{"tag":"text","content":["vector"]}]},{"tag":"text","content":[", que é o nome em Clojure para arrays ou vetores."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos imaginar que temos um ponto num plano cartesiano e que precisamos imprimir na tela as coordenadas, dizendo qual o valor de "]},{"tag":"italic","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[" e qual o valor de "]},{"tag":"italic","content":[{"tag":"text","content":["y"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Pelo que aprendemos até agora, sabendo que um ponto pode ser representado como um array de duas posições, nosso código ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ponto [10 20])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn mostre-coordenadas [p]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [x (first p)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        y (nth p 1)]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Coordenadas x:\" x \"y:\" y)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostre-coordenadas ponto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Coordenadas x: 10 y: 20"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[", vamos substituir o "]},{"tag":"monospaced","content":[{"tag":"text","content":["p"]}]},{"tag":"text","content":[" da lista de argumentos por um array de duas posições, que vamos chamar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["y"]}]},{"tag":"text","content":[", respectivamente:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ponto [10 20])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn mostre-coordenadas [[x y]]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Coordenadas x:\" x \"y:\" y))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostre-coordenadas ponto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Coordenadas x: 10 y: 20"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Atenção aos colchetes duplos"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Preste atenção nos dois colchetes para abrir e nos dois para fechar. Estamos dizendo para o compilador pegar um array, jogar o primeiro item em "]},{"tag":"monospaced","content":[{"tag":"text","content":["x"]}]},{"tag":"text","content":[" e o segundo em "]},{"tag":"monospaced","content":[{"tag":"text","content":["y"]}]},{"tag":"text","content":[". Se você esquecer dos colchetes extras, o compilador vai entender que você precisa passar dois parâmetros para a função e vai dar erro ao tentar executá-la passando apenas "]},{"tag":"monospaced","content":[{"tag":"text","content":["ponto"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No exemplo abaixo mostramos um código errado, para que você saiba o que acontece quando a lista de parâmetros é declarada de modo errado e que mensagem aparece. Note que no exemplo errado nós estamos usando apenas um par de colchetes, indicando que a função espera receber dois parâmetros:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ponto [10 20])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn mostre-erro [x y]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Coordenadas x:\" x \"y:\" y))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostre-erro ponto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; clojure.lang.ArityException: Wrong number of args (1)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; passed to: user$mostre-erro"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora você já sabe. Se estiver tentando usar "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" e esse erro aparecer, verifique se você não esqueceu dos colchetes extras."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Você pode utilizar também o recurso de aridade variável com "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[". Vamos criar uma função que receba uma lista de atletas que participaram de uma corrida, em ordem de chegada, mas só dê importância aos três primeiros, que são os que receberão as medalhas. Os nomes dos outros atletas ficarão em uma lista chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["outros"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que o tempo todo estamos usando dois colchetes para abrir e dois para fechar:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def resultado-100m [\"Usain Bolt\" \"Yohan Blake\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Justin Gatlin\" \"Tyson Gay\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Ryan Bailey\" \"Churandy Martina\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Richard Thompson\" \"Asafa Powell\"])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn podio [[primeiro segundo terceiro & outros]]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"100m rasos - Londres 2012\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Ouro: \" primeiro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Prata: \" segundo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Bronze: \" terceiro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"E mais\" (count outros) \"atletas\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(podio resultado-100m)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 100m rasos - Londres 2012"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ouro:  Usain Bolt"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Prata:  Yohan Blake"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Bronze:  Justin Gatlin"]},{"tag":"br","content":null},{"tag":"code-text","content":["; E mais 5 atletas"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":as"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Imagine agora que você queira ter acesso à lista completa de atletas que foi passada como argumento para a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["podio"]}]},{"tag":"text","content":[". Para isso existe um símbolo especial "]},{"tag":"monospaced","content":[{"tag":"text","content":[":as"]}]},{"tag":"text","content":[". Vamos criar uma função "]},{"tag":"monospaced","content":[{"tag":"text","content":["vencedor"]}]},{"tag":"text","content":[" que nos mostra quem ganhou e quantos atletas participaram."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A lista completa de atletas ficará armazenada em "]},{"tag":"monospaced","content":[{"tag":"text","content":["todos"]}]},{"tag":"text","content":[", enquanto "]},{"tag":"monospaced","content":[{"tag":"text","content":["primeiro"]}]},{"tag":"text","content":[" guarda apenas o primeiro item, como já vimos. A vírgula entre "]},{"tag":"monospaced","content":[{"tag":"text","content":["primeiro"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":[":as todos"]}]},{"tag":"text","content":[" é opcional, como sempre acontece em Clojure. Eu preferi colocar simplesmente para deixar claro que são coisas diferentes. Você decide se prefere usar ou não."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos ao código:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn vencedor [[primeiro, :as todos]]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Vencedor:\" primeiro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"participaram\" (count todos) \"atletas\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(vencedor resultado-100m)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como já dissemos, o uso de "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" pode ser usado com "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" também, de forma similar à que usamos na criação de funções."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def ponto [10 20])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn mostre-coordenadas [ponto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [[x y] ponto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Coordenadas x:\" x \"y:\" y)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Coordenadas x: 10 y: 20"]},{"tag":"br","content":null},{"tag":"code-text","content":["(mostre-coordenadas ponto)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como você deve imaginar, é possível também utilizar aridade variável com "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" no let, da mesma forma que utilizamos anteriormente na declaração da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["podio"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["vencedor"]}]},{"tag":"text","content":[" para exemplificar o uso:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def resultado-100m [\"Usain Bolt\" \"Yohan Blake\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Justin Gatlin\" \"Tyson Gay\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Ryan Bailey\" \"Churandy Martina\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     \"Richard Thompson\" \"Asafa Powell\"])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn vencedor [atletas]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [[primeiro & outros] atletas]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"100m rasos - Londres 2012\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"Vencedor: \" primeiro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"E mais\" (count outros) \"atletas\")))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(vencedor resultado-100m)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 100m rasos - Londres 2012"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Vencedor:  Usain Bolt"]},{"tag":"br","content":null},{"tag":"code-text","content":["; E mais 7 atletas"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O uso explícito de destructuring com "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" é bem menos comum, mas é uma ferramenta poderosa quando usada dentro de macros. Internamente a macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["fn"]}]},{"tag":"text","content":[" faz uso de destructuring com "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" para poder tratar os argumentos da função que está sendo criada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como "]},{"tag":"italic","content":[{"tag":"text","content":["strings"]}]},{"tag":"text","content":[" são tratadas como sequências de caracteres em Clojure, também podemos usar "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" com textos:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn tres-letras [[a b c]]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println a b c))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(tres-letras \"cavalo\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; c a v"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Map destructuring"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["destructuring, map"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A segunda forma de "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" é através de "]},{"tag":"italic","content":[{"tag":"text","content":["mapas"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["hashes"]}]},{"tag":"text","content":[" ou "]},{"tag":"italic","content":[{"tag":"text","content":["tuplas"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um mapa em Clojure segue a convenção "]},{"tag":"monospaced","content":[{"tag":"text","content":["{:chave valor}"]}]},{"tag":"text","content":[" e se parece muito com um "]},{"tag":"italic","content":[{"tag":"text","content":["Hash"]}]},{"tag":"text","content":[" encontrado em Ruby ou JavaScript."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para acessarmos um item de um mapa, informamos o nome do mapa como se fosse uma função e, sem seguida, a chave que queremos como se fosse um parâmetro da função."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para exemplificar, vamos criar um mapa chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["info-livro"]}]},{"tag":"text","content":[", que contém os dados de um livro. Esse mapa será usado nos nossos próximos exemplos, então vou evitar de repetí-lo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def info-livro"]},{"tag":"br","content":null},{"tag":"code-text","content":["  {:titulo \"Livro de Clojure\""]},{"tag":"br","content":null},{"tag":"code-text","content":["   :autor \"Plínio Balduino\""]},{"tag":"br","content":null},{"tag":"code-text","content":["   :capitulos {:capitulo01 \"Apresentação\""]},{"tag":"br","content":null},{"tag":"code-text","content":["               :capitulo02 \"Uma introdução gentil ao Clojure\"}})"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["str"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["descricao"]}]},{"tag":"text","content":[", que recebe esse mapa e exibe o autor e o título do livro. Aqui vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["str"]}]},{"tag":"text","content":[" para concatenar "]},{"tag":"italic","content":[{"tag":"text","content":["strings"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn descricao [livro]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"O autor de \" (livro :titulo) \" é \" (livro :autor)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(descricao info-livro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"O autor de Livro de Clojure é Plínio Balduino\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que "]},{"tag":"monospaced","content":[{"tag":"text","content":["livro"]}]},{"tag":"text","content":[" é repetido duas vezes em uma mesma linha. Se quiséssemos exibir três ou quatro informações, teríamos que repetí-lo tantas vezes quantas forem necessárias."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[", nosso código pode ficar um pouco mais limpo. Novamente, estou usando a vírgula apenas para deixar claro que "]},{"tag":"monospaced","content":[{"tag":"text","content":["titulo"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["autor"]}]},{"tag":"text","content":[" são coisas distintas e fica a seu crítério usá-la ou não."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn descricao [{titulo :titulo, autor :autor}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"O autor de \" titulo \" é \" autor))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(descricao info-livro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"O autor de Livro de Clojure é Plínio Balduino\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["To vírgula or not to vírgula"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Outra forma de deixar o código mais legível, sem apelar para o uso de vírgulas, é quebrando a linha e mantendo os símbolos alinhados."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dessa forma, nossa função ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn descricao [{titulo :titulo"]},{"tag":"br","content":null},{"tag":"code-text","content":["                  autor  :autor}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"O autor de \" titulo \" é \" autor))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Fica a seu critério, ou da sua equipe, decidir qual forma é melhor."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso mapa "]},{"tag":"monospaced","content":[{"tag":"text","content":["info-livro"]}]},{"tag":"text","content":[" existe um mapa contendo os nomes dos capítulos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Se quisermos exibir o nome do segundo capítulo da forma convencional, teríamos que acessar o valor da chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulos"]}]},{"tag":"text","content":[" para retornar um mapa e, a partir desse valor, acessar a chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulo02"]}]},{"tag":"text","content":[" para finalmente termos o texto que queremos:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn segundo-capitulo [livro]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"O segundo capítulo chama-se \""]},{"tag":"br","content":null},{"tag":"code-text","content":["       ((livro :capitulos) :capitulo02)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"O segundo capítulo chama-se Uma introdução gentil ao Clojure\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":keys"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existe uma forma de se utilizar "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" com mapas aninhados. Para isso vamos fazer uso do símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":[":keys"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn segundo-capitulo [{{:keys [capitulo02]} :capitulos}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"O segundo capítulo chama-se \" capitulo02))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(segundo-capitulo info-livro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"O segundo capítulo chama-se Uma introdução gentil ao Clojure\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Explicando esse código, fizemos com que o valor contido na chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulo02"]}]},{"tag":"text","content":[", que está dentro do valor contido na chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulos"]}]},{"tag":"text","content":[", seja retornado em "]},{"tag":"monospaced","content":[{"tag":"text","content":["capitulo02"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":strs"]}]},{"tag":"index","content":[{"tag":"text","content":[":syms"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Caso as chaves do mapa forem do tipo "]},{"tag":"italic","content":[{"tag":"text","content":["String"]}]},{"tag":"text","content":[" ao invés de um "]},{"tag":"italic","content":[{"tag":"text","content":["keyword"]}]},{"tag":"text","content":[", podemos usar "]},{"tag":"monospaced","content":[{"tag":"text","content":[":strs"]}]},{"tag":"text","content":[" no lugar de "]},{"tag":"monospaced","content":[{"tag":"text","content":[":keys"]}]},{"tag":"text","content":[". Da mesma forma, caso sejam símbolos, usaremos "]},{"tag":"monospaced","content":[{"tag":"text","content":[":syms"]}]},{"tag":"text","content":[" ao invés de "]},{"tag":"monospaced","content":[{"tag":"text","content":[":keys"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":as"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Assim como já acontece quando usamos "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" com sequências, podemos usar também o recurso "]},{"tag":"monospaced","content":[{"tag":"text","content":[":as"]}]},{"tag":"text","content":[" para armazenarmos o mapa inteiro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["detalhes"]}]},{"tag":"text","content":[", que exibe o título e todas as informações disponíveis sobre o livro:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn detalhes [{titulo :titulo"]},{"tag":"br","content":null},{"tag":"code-text","content":["                 :as livro}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str \"Dados do livro \" titulo \": \" livro))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(detalhes info-livro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Dados do livro Livro de Clojure: {:titulo \\\"Livro de Clojure\\"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \", :autor \\\"Plínio Balduino\\\", :capitulos {:capitulo01 \\\"Apres"]},{"tag":"br","content":null},{"tag":"code-text","content":["; entação\\\",  :capitulo02 \\\"Uma introdução gentil ao Clojure\\\"}\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":or"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um recurso muito interessante, especialmente quando formos tratar de configurações, é o símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":[":or"]}]},{"tag":"text","content":[", que é usado para definir valores padrão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos imaginar que nossa aplicação receba um mapa contendo a configuração, mas todos os itens são opcionais. A aplicação trabalharia de uma forma conhecida por padrão, mas você pode alterar apenas o que for relevante, evitando ter que repetir todas as configurações o tempo todo. Essa abordagem é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["convention over configuration"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Continuando o exercício de imaginação, vamos considerar que nossa aplicação roda em um browser, que por padrão vai ficar disponível apenas localmente, e que usa a porta 3000. Vamos dizer também que a aplicação usa um banco de dados MySQL como padrão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["iniciar"]}]},{"tag":"text","content":[", que recebe um mapa contendo as configurações que você quiser alterar, ou um mapa vazio se você quiser usar as configurações padrão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para mantermos o foco, essa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["iniciar"]}]},{"tag":"text","content":[" vai apenas exibir as configurações com as quais a aplicação seria iniciada."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":[":keys"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn iniciar [{:keys [ip porta db]"]},{"tag":"br","content":null},{"tag":"code-text","content":["                :or {ip \"127.0.0.1\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     porta 3000"]},{"tag":"br","content":null},{"tag":"code-text","content":["                     db \"mysql\"}}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"ip:\" ip \"porta:\" porta \"db:\" db))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(iniciar {})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ip: 127.0.0.1 porta: 3000 db: mysql"]},{"tag":"br","content":null},{"tag":"code-text","content":["(iniciar {:ip \"0.0.0.0\"})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ip: 0.0.0.0 porta: 3000 db: mysql"]},{"tag":"br","content":null},{"tag":"code-text","content":["(iniciar {:porta 80})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ip: 127.0.0.1 porta: 80 db: mysql"]},{"tag":"br","content":null},{"tag":"code-text","content":["(iniciar {:db \"oracle\"})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ip: 127.0.0.1 porta: 3000 db: oracle"]},{"tag":"br","content":null},{"tag":"code-text","content":["(iniciar {:db \"mssql\" :porta 8080})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ip: 127.0.0.1 porta: 8080 db: mssql"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Finalmente, existe uma forma de usarmos "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" que mistura o que vimos na manipulação de sequências com o que vimos na manipulação de mapas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Com essa forma podemos acessar diretamente um elemento de uma sequência sem que precisemos declarar todos os itens anteriores."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por exemplo, se quisermos apenas os terceiro e quinto atletas da nossa lista, podemos utilizar a forma associativa, informando a posição dos itens que queremos, lembrando que o primeiro item de uma sequência fica na posição "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn terceiro-quinto [{terceiro 2, quinto 4}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println terceiro \"chegou em terceiro\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println quinto \"chegou em quinto\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(terceiro-quinto resultado-100m)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Justin Gatlin chegou em terceiro"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ryan Bailey chegou em quinto"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A forma associativa também pode ser aplicado a "]},{"tag":"italic","content":[{"tag":"text","content":["strings"]}]},{"tag":"text","content":[", selecionando diretamente a letra que queremos. Vamos pegar a terceira letra de uma palavra qualquer:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(let [{terceira-letra 2} \"cavalo\"]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println terceira-letra))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; v"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vimos que "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[" é um recurso muito interessante para simplificar nosso código. Alguns autores"]},{"tag":"ref","content":[{"tag":"text","content":["joy-of-clojure"]}]},{"tag":"text","content":[" inclusive dizem que "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring é uma mini linguagem embutida no Clojure"]}]},{"tag":"text","content":[". Pratique bastante, escreva exemplos e aprenda quando seu uso pode ajudar e quando ele pode trazer apenas complicação."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Usando recursão"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Recursão acontece quando uma determinada função invoca ela própria para conseguir chegar a um resultado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em linguagens funcionais, que fazem uso constante de imutabilidade, como é o caso do Clojure, a recursão se torna a forma encontrada para iterar uma sequência ou simular um "]},{"tag":"italic","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Iterar"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Iterar"]}]},{"tag":"text","content":[" é o mesmo que repetir uma ação. Quando usamos um "]},{"tag":"monospaced","content":[{"tag":"text","content":["for"]}]},{"tag":"text","content":[" ou um "]},{"tag":"monospaced","content":[{"tag":"text","content":["while"]}]},{"tag":"text","content":[", no JavaScript e linguagens similares, estamos iterando, repetindo, algum processamento até que cheguemos a um resultado."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma função recursiva deve ter, sempre que possível, uma condição de saída, para que você não entre em um "]},{"tag":"italic","content":[{"tag":"text","content":["loop infinito"]}]},{"tag":"text","content":[" acidentalmente ou estoure a pilha de chamadas rapidamente."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma condição de saída é um desvio que faz com que a recursão seja finalizada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por exemplo, na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-1"]}]},{"tag":"text","content":[" vamos escrever uma função simples, que conte de qualquer número inteiro positivo até zero sem informar uma condição de saída."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Recursão desastrosa\" label=cap04-recur-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-ate-zero [num]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println num)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (conta-ate-zero (dec num)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-ate-zero 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 3"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 0"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ..."]},{"tag":"br","content":null},{"tag":"code-text","content":["; -5964"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -5965"]},{"tag":"br","content":null},{"tag":"code-text","content":["; StackOverflowError   clojure.walk/stringify-keys/fn--6998"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["dec"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["dec"]}]},{"tag":"text","content":[" retorna o "]},{"tag":"italic","content":[{"tag":"text","content":["decremento"]}]},{"tag":"text","content":[" de um número. "]},{"tag":"monospaced","content":[{"tag":"text","content":["(dec 10)"]}]},{"tag":"text","content":[" é equivalente a escrever "]},{"tag":"monospaced","content":[{"tag":"text","content":["(- 10 1)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Além da função não ter parado no zero, ela ainda estourou a pilha de chamadas da JVM. Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-2"]}]},{"tag":"text","content":[" Vamos então adicionar uma condição de parada usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["when"]}]},{"tag":"text","content":[", que é uma forma idiomática de usarmos um "]},{"tag":"monospaced","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[" que não faz nada caso a condição não seja satisfeita."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Recusão com condição de parada\" label=cap04-recur-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-ate-zero [num]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println num)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (when (> num 0)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        (conta-ate-zero (dec num))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-ate-zero 3)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 3"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 0"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao iterarmos uma sequência, dizemos que estamos consumindo-a, pois ela vai ficando menor a cada recursão, até que finalmente termine de ser processada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-3"]}]},{"tag":"text","content":[" vamos demonstrar uma função que recebe um texto qualquer e imprime uma letra por vez. Para isso essa função deve "]},{"tag":"italic","content":[{"tag":"text","content":["consumir a sequência de letras"]}]},{"tag":"text","content":[", e parar quando não houverem mais letras para imprimir."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para consumir corretamente o texto, que é tratado como uma sequência de caracteres, vamos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["first"]}]},{"tag":"text","content":[" para pegar a primeira letra, que é a que vamos imprimir, e a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["rest"]}]},{"tag":"text","content":[", que retorna uma cópia da sequência sem o primeiro item, ou uma lista vazia se não houver mais o que consumir. Ao usarmos isso com a palavra "]},{"tag":"italic","content":[{"tag":"text","content":["recursão"]}]},{"tag":"text","content":[", por exemplo, teremos "]},{"tag":"italic","content":[{"tag":"text","content":["r"]}]},{"tag":"text","content":[" como a primeira letra e "]},{"tag":"italic","content":[{"tag":"text","content":["ecursão"]}]},{"tag":"text","content":[" como o resto da sequência."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["rest"]}]},{"tag":"text","content":[" retorna uma sequência vazia caso não existam mais letras para retornar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["seq"]}]},{"tag":"text","content":[" retorna "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":[" caso o parâmetro passado seja uma sequência vazia. Como "]},{"tag":"monospaced","content":[{"tag":"text","content":["when nil"]}]},{"tag":"text","content":[" é equivalente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["when false"]}]},{"tag":"text","content":[", a nossa condição de parada acontecerá quando não tivermos mais letra para imprimir. Essa técnica é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["nil punning"]}]},{"tag":"text","content":[", sem nenhuma tradução decente para o português."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Além de imprimir a primeira letra de cada iteração, vamos mostrar também o resto da sequência, que será passado como parâmetro para a próxima iteração, e o resultado do "]},{"tag":"italic","content":[{"tag":"text","content":["nil punning"]}]},{"tag":"text","content":[" na última iteração. Isso vai ajudar a demonstrar passo a passo o que acontece, para que você não fique perdido e jogue o livro na parede."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Consumindo uma sequência\" label=cap04-recur-3"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn imprime-letra [texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [letra (first texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        resto (rest texto)]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"letra =\" letra"]},{"tag":"br","content":null},{"tag":"code-text","content":["             \"- resto =\" resto"]},{"tag":"br","content":null},{"tag":"code-text","content":["             \"- (seq resto) =\" (seq resto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (when (seq resto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (imprime-letra resto))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(imprime-letra \"recursão\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = r - resto = (e c u r s ã o) - (seq resto) = (e c u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = e - resto = (c u r s ã o) - (seq resto) = (c u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = c - resto = (u r s ã o) - (seq resto) = (u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = u - resto = (r s ã o) - (seq resto) = (r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = r - resto = (s ã o) - (seq resto) = (s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = s - resto = (ã o) - (seq resto) = (ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = ã - resto = (o) - (seq resto) = (o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = o - resto = () - (seq resto) = nil"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Temos nossa função recursiva funcionando, mas e se recebermos um texto muito grande?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A cada iteração, consumimos uma posição na pilha de chamadas da JVM. Como sabemos, essa pilha tem um tamanho limitado e, mesmo existindo formas de configurar a JVM para que esse tamanho seja ampliado, a pilha continuará tendo um tamanho finito."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Tail call optimization, ou quase"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Felizmente, o cientista Guy Steele Jr, que participou da criação do Java e da linguagem Scheme, publicou um artigo"]},{"tag":"ref","content":[{"tag":"text","content":["ultimate-goto"]}]},{"tag":"text","content":[" descrevendo uma técnica que se tornou conhecida por "]},{"tag":"italic","content":[{"tag":"text","content":["tail call optimization"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Tail call"]}]},{"tag":"text","content":[" é o nome dado à última chamada dentro de uma função (listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-4"]}]},{"tag":"text","content":["). Quando essa última chamada invoca a própria função (listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-5"]}]},{"tag":"text","content":["), e não há mais nada a ser processado após isso, ela é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["tail call recursion"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"text","content":[" \"A chamada à função limpar é o tail call\" label=cap04-recur-4"]},{"tag":"br","content":null},{"tag":"code-text","content":["function processaDados( ) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // código da função"]},{"tag":"br","content":null},{"tag":"code-text","content":["  limpar();"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"text","content":[" \"Exemplo de tail call recursion\" label=cap04-recur-5"]},{"tag":"br","content":null},{"tag":"code-text","content":["function imprimeLetra(texto) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  // código da função"]},{"tag":"br","content":null},{"tag":"code-text","content":["  imprimeLetra(resto);"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em algumas linguagens, como é o caso do Scheme, o compilador verifica se a "]},{"tag":"italic","content":[{"tag":"text","content":["tail call"]}]},{"tag":"text","content":[" faz uma chamada recursiva e otimiza o código compilado, fazendo com que a chamada não consuma espaço na pilha e permitindo assim que o código utilize recursão indefinidamente, sem o risco de causar um estouro de pilha. Essa otimização é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["tail call optimization"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["recur"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Infelizmente, a JVM não dá suporte a esse tipo de otimização. Felizmente, os desenvolvedores do Clojure deram um jeito de imitar "]},{"tag":"italic","content":[{"tag":"text","content":["tail call optimization"]}]},{"tag":"text","content":[" através da forma especial "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para reescrevermos nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["imprime-letra"]}]},{"tag":"text","content":[" usando a \"quase "]},{"tag":"italic","content":[{"tag":"text","content":["tail call optimization"]}]},{"tag":"text","content":["\", basta fazer com que, ao invés de executarmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["(imprime-letra resto)"]}]},{"tag":"text","content":[" no final da função, executemos "]},{"tag":"monospaced","content":[{"tag":"text","content":["(recur resto)"]}]},{"tag":"text","content":[", e o compilador vai se encarregar de gerar um bytecode parecido com o que seria gerado caso a JVM suportasse esse tipo de otimização."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-6"]}]},{"tag":"text","content":[", o código fica praticamente igual ao original, mas agora não corremos mais o risco de estourar a pilha de chamadas."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Usando tail call optimization com recur\" label=cap04-recur-6"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn imprime-letra [texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (let [letra (first texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        resto (rest texto)]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"letra =\" letra"]},{"tag":"br","content":null},{"tag":"code-text","content":["             \"- resto =\" resto"]},{"tag":"br","content":null},{"tag":"code-text","content":["             \"- (seq resto) =\" (seq resto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (when (seq resto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (recur resto))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(imprime-letra \"recursão\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = r - resto = (e c u r s ã o) - (seq resto) = (e c u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = e - resto = (c u r s ã o) - (seq resto) = (c u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = c - resto = (u r s ã o) - (seq resto) = (u r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = u - resto = (r s ã o) - (seq resto) = (r s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = r - resto = (s ã o) - (seq resto) = (s ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = s - resto = (ã o) - (seq resto) = (ã o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = ã - resto = (o) - (seq resto) = (o)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; letra = o - resto = () - (seq resto) = nil"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Internamente, a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" transforma a chamada recursiva de função em um "]},{"tag":"italic","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[", equivalente ao "]},{"tag":"monospaced","content":[{"tag":"text","content":["while"]}]},{"tag":"text","content":[" do Java, fazendo com que o seu código itere sem consumir a pilha de chamadas. É uma malandragem criticada pelos usuários de dialetos mais antigos de LISP, mas que não atrapalha em nada a forma como o seu código vai funcionar. Levando em conta as limitações da JVM, podemos considerar que foi uma solução bem elegante."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora que sabemos como escrever funções recursivas que não estourem a pilha de chamadas, vamos avançar mais um pouco."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos escrever uma função que receba um texto e nos retorne a quantidade de vogais que ele contém."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Entendendo loop passo a passo"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro vamos precisar diferenciar o que é uma vogal e o que é qualquer outro caracter. Vamos usar as propriedades de uma estrutura de dados chamada "]},{"tag":"italic","content":[{"tag":"text","content":["set"]}]},{"tag":"text","content":[" para facilitar a nossa vida. Vamos ver essa estrutura com mais detalhes no próximo capítulo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-7"]}]},{"tag":"text","content":[", vamos criar um "]},{"tag":"italic","content":[{"tag":"text","content":["set"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogal?"]}]},{"tag":"text","content":[", contendo as vogais do nosso alfabeto. Esse "]},{"tag":"italic","content":[{"tag":"text","content":["set"]}]},{"tag":"text","content":[" recebe um caracter e retorna "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":[" caso não seja uma vogal, ou a própria vogal, caso seja."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Lembrando do que vimos sobre "]},{"tag":"italic","content":[{"tag":"text","content":["nil punning"]}]},{"tag":"text","content":[", sabemos que "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":[" é equivalente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["false"]}]},{"tag":"text","content":[" quando estamos avaliando uma condição."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Isso significa que, se você passar uma vogal para "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogal?"]}]},{"tag":"text","content":[", receberá um resultado "]},{"tag":"italic","content":[{"tag":"text","content":["equivalente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["true"]}]}]},{"tag":"text","content":[" e, se passar qualquer outro valor, receberá um resultado "]},{"tag":"italic","content":[{"tag":"text","content":["equivalente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["false"]}]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Código que nos diz se é vogal ou não\" label=cap04-recur-7"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def vogal? (set \"aeiouAEIOU\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(vogal? \\a)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \\a"]},{"tag":"br","content":null},{"tag":"code-text","content":["(vogal? \\c)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; nil"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um caracter em Clojure é escrito com o caracter "]},{"tag":"monospaced","content":[{"tag":"text","content":["\\"]}]},{"tag":"text","content":[" seguido do caracter propriamente dito. A letra "]},{"tag":"italic","content":[{"tag":"text","content":["a"]}]},{"tag":"text","content":[", por exemplo, é escrita como "]},{"tag":"monospaced","content":[{"tag":"text","content":["\\a"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando o que já sabemos, vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":[". Nessa função vamos consumir o texto que recebermos por parâmetro e também acumular a quantidade de variáveis conforme elas forem encontradas em cada iteração."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Você já deve ter percebido que, no exemplo anterior, a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" recebeu exatamente a mesma quantidade de parâmetros da função. Isso acontece porque, basicamente, "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" faz uma chamada à função atual, só que sem consumir a pilha de chamadas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para contar a quantidade de vogais de um texto, precisaremos usar dois "]},{"tag":"italic","content":[{"tag":"text","content":["bindings"]}]},{"tag":"text","content":[", sendo um para a quantidade de vogais propriamente dita e outro contendo a sequência de caracteres que está sendo consumida."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Então podemos pensar em começar a nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":[" usando dois parâmetros: "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogais"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["texto"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-vogais [vogais texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if (seq texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (recur"]},{"tag":"br","content":null},{"tag":"code-text","content":["    ; continua"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Note que usamos "]},{"tag":"italic","content":[{"tag":"text","content":["nil punning"]}]},{"tag":"text","content":[" no "]},{"tag":"monospaced","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[". É uma técnica tão comum que poderíamos dizer até que "]},{"tag":"italic","content":[{"tag":"text","content":["nil punning"]}]},{"tag":"text","content":[" é um "]},{"tag":"italic","content":[{"tag":"text","content":["design pattern"]}]},{"tag":"text","content":[" funcional. Note também que abrimos os parênteses, mas não fechamos. Fizemos assim porque os códigos a seguir vão se encaixando até formarmos o código todo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos verificar se o primeiro caracter que estamos recebendo é uma vogal. Se for, incrementaremos o valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogais"]}]},{"tag":"text","content":[". Caso contrário, ele continuará igual. Se nosso texto não tiver nenhuma vogal, passaremos "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[" em cada uma das iterações e, no final, teremos zero vogais encontradas no texto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos usar o "]},{"tag":"monospaced","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[", que recebe três parâmetros. O primeiro é uma condição, o segundo contém a expressão a ser avaliada caso a expressão seja verdadeira, e a terceira contém a expressão a ser avaliada caso a expressão seja falsa. Pense que em Clojure até o "]},{"tag":"monospaced","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[" tem jeitão de função."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["      (if (vogal? (first texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["                  (inc vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["                  vogais)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O segundo parâmetro a ser usado pelo "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" é o resto da sequência, sem o primeiro caracter. Como já verificamos se o primeiro caracter é ou não uma vogal, não vamos mais precisar dele."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Finalmente, caso não tenhamos mais letras para verificar, vamos fazer a função retornar apenas o número de vogais que encontramos, que é o nosso objetivo desde o início."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código completo da função ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Primeira versão do contador de vogais\" label=cap04-recur-8"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-vogais [vogais texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if (seq texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (recur (if (vogal? (first texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["                 (inc vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["                 vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["             (rest texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["       vogais))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-vogais 0 \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossa função está funcionando e contando as vogais corretamente, mas temos um grande problema aqui: somos obrigados a informar esse "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[" como parâmetro toda vez que quisermos usar a função. Para piorar a situação, se o usuário usar qualquer outro número, a função vai devolver um valor incorreto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Temos aqui um caso clássico de design horrível."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos então renomear a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":[" para "]},{"tag":"monospaced","content":[{"tag":"text","content":["contador-auxiliar"]}]},{"tag":"text","content":[" e criar uma nova função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":[" que chama a nossa função original com o "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[" problemático:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Segunda versão do contador de vogais\" label=cap04-recur-9"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn acumulador-auxiliar [vogais texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if (seq texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (recur (if (vogal? (first texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["                 (inc vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["                 vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["             (rest texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["       vogais))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-vogais [texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (acumulador-auxiliar 0 texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-vogais \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-9"]}]},{"tag":"text","content":[" já está melhor, evitando que o usuário tenha que informar o valor "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[" como parâmetro toda vez, mas ainda tem que melhorar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora temos duas funções, sendo "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":[" que recebe apenas um texto e nos retorna a quantidade de vogais, exatamente como queremos, e uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["acumulador-auxiliar"]}]},{"tag":"text","content":[", que tem um nome que não ajuda muito e que não vai ser utilizada em nenhum outro lugar. Chamar a função de "]},{"tag":"monospaced","content":[{"tag":"text","content":["acumulador-auxiliar-para-contar-vogais"]}]},{"tag":"text","content":[" não ajuda em nada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Lá no começo do capítulo dissemos que funções anônimas são úteis para quando não precisamos utilizá-las em outra parte da aplicação. Podemos então converter a nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["acumulador-auxiliar"]}]},{"tag":"text","content":[" em uma função anônima dentro de "]},{"tag":"monospaced","content":[{"tag":"text","content":["conta-vogais"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como o código que está dentro de "]},{"tag":"monospaced","content":[{"tag":"text","content":["acumulador-auxiliar"]}]},{"tag":"text","content":[" não vai ser alterado, vamos apenas indicar sua localização com um comentário para o livro não se transforme em uma bagunça e para que você não se perca na explicação."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Terceira versão do nosso contador de vogais\" label=cap04-recur-10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-vogais [texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  ((fn [vogais texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    ; aqui vem o código que estava dentro da"]},{"tag":"br","content":null},{"tag":"code-text","content":["    ; função contador-auxiliar"]},{"tag":"br","content":null},{"tag":"code-text","content":["    ) 0 texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-vogais \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora temos apenas uma função, que recebe apenas o texto e nos devolve a quantidade correta de vogais. Funciona, mas está difícil de ler."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Os dois parênteses juntos logo no começo do código, para que possamos invocar uma função anônima assim que ela é criada, causa arrepios em quem já não gosta muito dos parênteses de um LISP. E aquele "]},{"tag":"monospaced","content":[{"tag":"text","content":["0 texto"]}]},{"tag":"text","content":[" ali embaixo dão uma sensação de coisa fora do lugar."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["loop"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Felizmente, a linguagem oferece uma construção que abstrai essa bagunça e deixa nosso código tão simples de ler quanto o "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" deixou lá no início do exemplo. Ela se chama "]},{"tag":"monospaced","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[", e é uma mistura de "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":[" com função anônima."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Internamente, o "]},{"tag":"monospaced","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[" informa para o "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" o ponto para o qual a recursão deve voltar na próxima iteração. É como a função anônima da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-recur-10"]}]},{"tag":"text","content":[", mas sem os parênteses extras nem os parâmetros perdidos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao invés de declararmos a função anônima, vamos declarar "]},{"tag":"monospaced","content":[{"tag":"text","content":["(loop"]}]},{"tag":"text","content":[", em seguida um vetor contendo os bindings "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogais"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["texto"]}]},{"tag":"text","content":[" e os respectivos valores iniciais, que são "]},{"tag":"italic","content":[{"tag":"text","content":["0"]}]},{"tag":"text","content":[" e o valor passado por parâmetro para a função, assim como faríamos em um "]},{"tag":"monospaced","content":[{"tag":"text","content":["let"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossa última versão ficaria com essa cara:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Versão final do contador de vogais\" label=cap04-recur-11"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn conta-vogais [texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (loop [vogais 0"]},{"tag":"br","content":null},{"tag":"code-text","content":["         texto  texto]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (if (seq texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["        (recur (if (vogal? (first texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["                   (inc vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["                   vogais)"]},{"tag":"br","content":null},{"tag":"code-text","content":["               (rest texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["        vogais)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-vogais \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A quantidade de parâmetros que passamos ao "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" deve ser igual à quantidade de "]},{"tag":"monospaced","content":[{"tag":"text","content":["bindings"]}]},{"tag":"text","content":[" que o "]},{"tag":"monospaced","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[" declara, assim como em um "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" sem "]},{"tag":"monospaced","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[", a quantidade de parâmetros deve ser a mesma que a função declara."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora que já sabemos como criar funções recursivas sem medo de estourar a pilha de chamadas da JVM, podemos processar dados que estão em uma sequência sem nos preocupar tanto com seu tamanho."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem casos em que a recursão não é a melhor das soluções, mas existem estratégias que vamos apresentar no decorrer do livro. A partir daí vai caber a você avaliar qual a melhor técnica para resolver cada tipo de problema."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Closures, currying e aplicações parciais"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Geralmente, se você é um programador habituado a linguagens imperativas, o primeiro contato com os conceitos da programação funcional acontece através de artigos na Wikipedia ou textos contendo cargas assustadoras de conceitos matemáticos e termos aparentemente ininteligíveis."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Infelizmente isso afasta o programador comum, como eu ou você, que não tem intenção de ir atrás de um mestrado em matemática apenas para entender o que é que os autores desses textos crípticos tentaram dizer."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A boa notícia é que os conceitos básicos da programação funcional são muito simples e, com um pouco de prática, podem entrar facilmente para o seu arsenal de técnicas de desenvolvimento."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro vamos criar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudacao"]}]},{"tag":"text","content":[", que recebe dois parâmetros. O primeiro contém uma mensagem simpática e o segundo contém um nome. É uma função bem bacana para utilizarmos assim que o usuário se conectar a um sistema."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Um jeito repetitivo de dar bom dia\" label=cap04-closure-0"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn saudacao [mensagem nome]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (str mensagem \", \" nome))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(saudacao \"Bom dia\" \"João\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, João\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(saudacao \"Bom dia\" \"José\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, José\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(saudacao \"Bom dia\" \"Nicolau\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, Nicolau\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossa função retorna as saudações corretamente na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-0"]}]},{"tag":"text","content":[", mas em cada chamada de função temos que repetir a mensagem. E se houvesse um jeito de dizer apenas uma vez que a saudação deve ser "]},{"tag":"italic","content":[{"tag":"text","content":["Bom dia"]}]},{"tag":"text","content":[" e precisássemos informar somente o nome?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Pois isso é possível reescrevendo a função como na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-1"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Reduzindo a repetição usando closure\" label=cap04-closure-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn saudacao [mensagem]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fn [nome]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (str mensagem \", \" nome)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def bom-dia (saudacao \"Bom dia\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bom-dia \"João\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, João\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(bom-dia \"José\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, José\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(bom-dia \"Nicolau\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Bom dia, Nicolau\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A nossa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudação"]}]},{"tag":"text","content":[" agora retorna uma função anônima. Sempre que uma função recebe outra como parâmetro ou devolve outra função como resultado, a chamamos de "]},{"tag":"italic","content":[{"tag":"text","content":["high order function"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Essa função anônima que foi retornada recebe um parâmetro "]},{"tag":"monospaced","content":[{"tag":"text","content":["nome"]}]},{"tag":"text","content":[" e o concatena ao valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[" que foi passado por parâmetro usando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["str"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O interessante aqui é que "]},{"tag":"monospaced","content":[{"tag":"text","content":["bom-dia"]}]},{"tag":"text","content":[" guarda a função anônima retornada por "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudacao"]}]},{"tag":"text","content":[", que guarda todo o contexto existente em "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudação"]}]},{"tag":"text","content":[" no momento em que foi criada. Isso significa, de maneira simplificada, que "]},{"tag":"italic","content":[{"tag":"text","content":["a função anônima se lembra do momento em que foi criada"]}]},{"tag":"ref","content":[{"tag":"text","content":["function-of-function"]}]},{"tag":"text","content":[". Chamamos essa "]},{"tag":"italic","content":[{"tag":"text","content":["lembrança"]}]},{"tag":"text","content":[" de "]},{"tag":"italic","content":[{"tag":"text","content":["closure"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dito isso, sabemos que a função anônima se lembra do valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[", mesmo depois que a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudacao"]}]},{"tag":"text","content":[" já não está mais sendo executada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao executarmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["saudacao"]}]},{"tag":"text","content":[" novamente, criaremos uma nova função anônima, que vai guardar o valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[" que foi utilizado dessa vez."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Fazendo uma analogia com a orientação a objetos, a cada vez que você cria um objeto, ele encapsula informações que independem da existência de outro objeto do mesmo tipo. Da mesma forma, "]},{"tag":"italic","content":[{"tag":"text","content":["closures"]}]},{"tag":"text","content":[" encapsulam informação dentro de uma função, independente do fato de existirem outras funções."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos tentar atribuir a função anônima diretamente a "]},{"tag":"monospaced","content":[{"tag":"text","content":["bom-dia"]}]},{"tag":"text","content":[", sem usar "]},{"tag":"italic","content":[{"tag":"text","content":["closure"]}]},{"tag":"text","content":[". Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-2"]}]},{"tag":"text","content":[" vemos o que acontece."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Usando a função anônima sem closure\" label=cap04-closure-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def bom-dia (fn [nome]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (str mensagem \", \" nome)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; CompilerException java.lang.RuntimeException:"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Unable to resolve symbol: mensagem in this context"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Antes mesmo de tentarmos executar "]},{"tag":"monospaced","content":[{"tag":"text","content":["bom-dia"]}]},{"tag":"text","content":[", o compilador acusou que não existe o símbolo "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[". Isso aconteceu porque, no nosso código original da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-1"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[" foi definida fora da função anônima."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Isso significa que "]},{"tag":"monospaced","content":[{"tag":"text","content":["mensagem"]}]},{"tag":"text","content":[", dentro do contexto da função anônima, é uma "]},{"tag":"italic","content":[{"tag":"text","content":["variável livre"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Para os puristas..."]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em termos mais técnicos, uma "]},{"tag":"italic","content":[{"tag":"text","content":["closure"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["lexical closure"]}]},{"tag":"text","content":[", é uma função anônima cujas variáveis livres foram presas, ou enclausuradas ("]},{"tag":"italic","content":[{"tag":"text","content":["closed"]}]},{"tag":"text","content":[", em inglês) pelo escopo léxico em que ela foi criada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Closure"]}]},{"tag":"text","content":[" também é o nome em inglês para aquilo que fecha um recipiente, como um tampa ou rolha."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já a função anônima, que depende de "]},{"tag":"italic","content":[{"tag":"text","content":["closure"]}]},{"tag":"text","content":[" para funcionar, é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["aplicação parcial"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["partial function application"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["partial"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existe uma função em Clojure específica para criarmos aplicações parciais, que recebe o nome óbvio de "]},{"tag":"monospaced","content":[{"tag":"text","content":["partial"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-1"]}]},{"tag":"text","content":[" ficaria assim usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["partial"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn saudacao [mensagem]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (partial str mensagem \", \"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def bom-dia (saudacao \"Bom dia\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bom-dia \"Luis\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Bom dia, Luis"]},{"tag":"br","content":null},{"tag":"code-text","content":["(bom-dia \"Luis \" \"Carlos\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Bom dia, Luis Carlos"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Todas os argumentos recebidos pela função criada com "]},{"tag":"monospaced","content":[{"tag":"text","content":["partial"]}]},{"tag":"text","content":[" são adicionados no final da expressão."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Partial e currying"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Outra palavra mágica na programação funcional, e que frequentemente causa confusão e medo, é "]},{"tag":"italic","content":[{"tag":"text","content":["currying"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Currying"]}]},{"tag":"text","content":[" nada mais é do que a técnica de transformar uma função que receba N argumentos em N funções com um argumento cada. Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-closure-3"]}]},{"tag":"text","content":[" é apresentado um exemplo de como uma função comum é transformada usando "]},{"tag":"italic","content":[{"tag":"text","content":["currying"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"text","content":[" \"Demonstrando currying com uma pseudolinguagem\" label=cap04-closure-3"]},{"tag":"br","content":null},{"tag":"code-text","content":["// a função original"]},{"tag":"br","content":null},{"tag":"code-text","content":["y = f(a, b, c)"]},{"tag":"br","content":null},{"tag":"code-text","content":["// a função 'curried'"]},{"tag":"br","content":null},{"tag":"code-text","content":["g = f(a)"]},{"tag":"br","content":null},{"tag":"code-text","content":["h = g(b)"]},{"tag":"br","content":null},{"tag":"code-text","content":["y = h(c)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O termo é frequentemente confundido com aplicação parcial"]},{"tag":"ref","content":[{"tag":"text","content":["partial-not-curry"]}]},{"tag":"text","content":[", devido ao fato de que, em determinados casos, ambos se sobrepõe e parecem ser a mesma coisa"]},{"tag":"ref","content":[{"tag":"text","content":["vidal-curry"]}]},{"tag":"text","content":[" e, apesar do Clojure ter suporte nativo a aplicação parcial, não existe uma forma transparente de utilizar "]},{"tag":"italic","content":[{"tag":"text","content":["currying"]}]},{"tag":"text","content":[", como acontece na linguagem "]},{"tag":"italic","content":[{"tag":"text","content":["Haskell"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Não se preocupe em tentar usar "]},{"tag":"italic","content":[{"tag":"text","content":["currying"]}]},{"tag":"text","content":[" em Clojure. Na maior parte do tempo, o uso de aplicação parcial vai fazer o trabalho sem problemas."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Memoização"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Memoização"]},{"tag":"ref","content":[{"tag":"text","content":["memo-functions"]}]},{"tag":"text","content":[" é uma técnica de otimização em que você troca processamento por memória."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao "]},{"tag":"italic","content":[{"tag":"text","content":["memoizar"]}]},{"tag":"text","content":[" uma função, é criado um mapa em memória contendo os parâmetros de entrada e o valor de retorno."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na primeira vez que a função é executada, é adicionado um item nesse mapa e, nas próximas vezes, ao invés de executá-la, o valor é extraido diretamente do mapa, reduzindo consideravelmente o tempo de retorno."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Memoization e closure"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Caso você tenha curiosidade de ir mais a fundo na linguagem, o código fonte da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["memoize"]}]},{"tag":"text","content":[" é um ótimo exemplo de uso real de "]},{"tag":"italic","content":[{"tag":"text","content":["closure"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dentro do REPL, digite "]},{"tag":"monospaced","content":[{"tag":"text","content":["(source memoize)"]}]},{"tag":"text","content":[" e releia os parágrafos acima acompanhando as linhas de código para entender melhor a função."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Pode ir sem medo. O código é bem curto e simples de entender."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["time"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A biblioteca padrão do Clojure nos fornece uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["time"]}]},{"tag":"text","content":[", que informa o tempo que uma expressão leva para ser executada."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Thread/sleep"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função propositadamente lenta, que retorna o mesmo valor que usarmos como entrada. Vamos usar um "]},{"tag":"monospaced","content":[{"tag":"text","content":["sleep"]}]},{"tag":"text","content":[" de dois segundos para deixar a função lenta:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn lento [x]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 2000)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  x)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(time (lento 10))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 2017.528206 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função levou um pouco mais de dois segundos para ser retornar o mesmo valor que usamos como argumento. Fizemos isso para simular um cálculo demorado e complexo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos agora usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["memoize"]}]},{"tag":"text","content":[", que recebe a função lenta como parâmetro e nos devolve uma versão memoizada da função lenta."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos ao código:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def memo-lento (memoize lento))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(time (memo-lento 10))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 2017.185984 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(time (memo-lento 10))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 0.029892 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na primeira vez que executamos a versão memoizada, o tempo de execução foi praticamente o mesmo. Porém, na segunda vez, a função centésimos de segundo para retornar o mesmo valor. Sem dúvida, uma grande diferença."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma coisa importante e que deve ser deixada explícita, é que "]},{"tag":"bold","content":[{"tag":"text","content":["você só deve memoizar funções puras"]}]},{"tag":"text","content":[", sem efeitos colaterais. Como a função só será executada na primeira vez, qualquer efeito colateral deixará de ocorrer nas vezes seguintes."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Funções puras"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma função pura é simplesmente aquela que não causa efeito colateral durante a sua execução. Um acesso ao banco de dados, ao sistema de arquivos, à rede, a alteração de um valor global ou mesmo o ato de imprimir algo na tela são exemplos de efeitos colaterais."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Assim como a imutabilidade, o conceito de pureza de função é muito importante para a programação funcional."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando falamos em imutabilidade, não significa que todos os seus dados devam ser imutáveis, mas que as partes mutáveis devam ser isoladas e mantidas sob controle."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Da mesma forma, uma aplicação que seja totalmente pura não tem lá muita utilidade prática, então é uma boa prática isolarmos as funções impuras das puras, para que não tenhamos surpresas com comportamentos imprevistos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um exemplo simples de função pura é a operação aritmética de soma, que recebe um conjunto de valores e devolve uma resposta, sem alterar mais nada no ambiente."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função com efeito colateral para demonstrar. No nosso exemplo, o efeito colateral será uma mensagem impressa na tela, mas na sua aplicação poderia ser um acesso à rede, ao arquivo ou a qualquer outro recurso externo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn colateral [x]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Imprimindo \" x)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  x)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(colateral 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Imprimindo  10"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def memo-colateral (memoize colateral))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(memo-colateral 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Imprimindo  10"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(memo-colateral 10)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null},{"tag":"code-text","content":["(memo-colateral 30)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Imprimindo  30"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 30"]},{"tag":"br","content":null},{"tag":"code-text","content":["(memo-colateral 30)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 10"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["É algo esperado se você se lembrar de que a função é executada apenas uma vez para cada argumento utilizado. O efeito colateral só ocorreu uma vez quando utilizamos o valor "]},{"tag":"italic","content":[{"tag":"text","content":["10"]}]},{"tag":"text","content":[", e aconteceu novamente uma vez ao utilizarmos o valor "]},{"tag":"italic","content":[{"tag":"text","content":["30"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Memoization e recursão"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O recurso de usar memoização com recursão pode ajudar bastante em cálculos pesados, mas exige alguns cuidados."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Fibonacci"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vou utilizar a versão recursiva do cálculo do enésimo número da sequência de Fibonacci para demonstrar como podemos otimizar utilizando memoização e, em seguida, os tais cuidados que você precisa ter."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A sequência de Fibonacci consiste em um número subsequente igual ao resultado da soma dos dois anteriores. No nosso exemplo, vamos começar pelo "]},{"tag":"italic","content":[{"tag":"text","content":["1"]}]},{"tag":"text","content":[", então teremos "]},{"tag":"italic","content":[{"tag":"text","content":["1"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["3"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["5"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["8"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["13"]}]},{"tag":"text","content":[" e assim por diante."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["zero?"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn fib [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if  (or (zero? n) (= n 1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    1"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (+ (fib (- n 1)) (fib (- n 2)))))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Apenas como um lembrete amigável, essa é a segunda pior forma possível de se calcular a sequência de Fibonacci. De acordo com a minha experiência, a pior forma é tentar calcular com um lápis de ponta quebrada num papel de pão. De qualquer maneira, é uma forma válida para o que pretendemos fazer."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos calcular o quadragésimo item da sequência e apresentar o tempo que levaremos para calculá-lo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(time (fib 40))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 28777.402994 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 165580141"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nossa função levou 28 segundos para calcular 40 números. E esse tempo cresce numa progressão geométrica se você tentar calcular um valor maior."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/recursao.png \"Grafo de chamadas de (fib 5)\" label=diagrama-recursao w=50%"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O diagrama da figura "]},{"tag":"ref-label","content":[{"tag":"text","content":["diagrama-recursao"]}]},{"tag":"text","content":[" mostra que tivemos onze chamadas de função para calcular o quinto número da sequência. Se tivessemos calculado o sexto número, teríamos dezenove chamadas. Apenas a título de curiosidade, nosso cálculo do quadragésimo item fez 267.914.294 chamadas de função, e "]},{"tag":"monospaced","content":[{"tag":"text","content":["(fib 2)"]}]},{"tag":"text","content":[" é calculado mais de setecentas vezes."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Sem dúvida nenhuma, o nosso algoritmo é totalmente ineficiente."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por que não melhoramos isso e reduzimos o cálculo para apenas uma vez em cada argumento?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Fácil, vamos memoizar tudo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn fib [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if  (or (zero? n) (= n 1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    1"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (+ (fib (- n 1)) (fib (- n 2)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def memo-fib (memoize fib))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(time (memo-fib 40))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 29374.836646 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 165580141"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O tempo permaneceu praticamente o mesmo. Isso acontece porque memoizamos apenas a execução de "]},{"tag":"monospaced","content":[{"tag":"text","content":["(fib 40)"]}]},{"tag":"text","content":[". Todas as outras repetições desnecessárias continuam acontecendo internamente."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos então fazer com que a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["fib"]}]},{"tag":"text","content":[" chame a sua versão memoizada, "]},{"tag":"monospaced","content":[{"tag":"text","content":["memo-fib"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O problema dessa solução é que temos aqui aquele velho paradoxo do ovo e da galinha: como memoizar uma função que ainda não existe? Ou como fazer a função chamar sua versão memoizada se ela ainda não foi memoizada?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O nosso código demonstra o que você vai encontrar se insistir em ignorar o paradoxo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn fib [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if  (or (zero? n) (= n 1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    1"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (+ (memo-fib (- n 1)) (fib (- n 2)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; CompilerException java.lang.RuntimeException: Unable to resolve"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   symbol: memo-fib in this context"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O compilador do Clojure tem uma tabela de "]},{"tag":"italic","content":[{"tag":"text","content":["vars"]}]},{"tag":"text","content":[" com seus respectivos nomes. Ao tentar compilar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["fib"]}]},{"tag":"text","content":[", o compilador não encontrou o "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["memo-fib"]}]},{"tag":"text","content":[" em sua tabela interna e lançou uma exceção nos informando o problema."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["forward declaration"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para resolver isso, vamos usar uma técnica chamada "]},{"tag":"italic","content":[{"tag":"text","content":["forward declaration"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["declaração prematura"]}]},{"tag":"text","content":[" numa tradução livre."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A sacada da declaração prematura é que o "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" precisa existir, mas a função não, pois ela só será chamada quando executarmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["fib"]}]},{"tag":"text","content":[". Então temos tempo suficiente para fazer "]},{"tag":"monospaced","content":[{"tag":"text","content":["fib"]}]},{"tag":"text","content":[" chamar sua versão memoizada e só então efetuarmos a memoização."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso código então ficaria assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Resolvendo Fibonacci com memoização\" label=cap04-forward-declaration"]},{"tag":"br","content":null},{"tag":"code-text","content":["(declare memo-fib) ; aqui o var é criado"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn fib [n]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (if  (or (zero? n) (= n 1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["    1"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (+ (memo-fib (dec n)) (memo-fib (- n 2)))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def memo-fib (memoize fib)) ; e só aqui ele recebe a memoização"]},{"tag":"br","content":null},{"tag":"code-text","content":["(time (memo-fib 40))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Elapsed time: 0.244445 msecs\""]},{"tag":"br","content":null},{"tag":"code-text","content":["; 165580141"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Reduzimos o tempo de execução de 27 segundos para apenas dois décimos, mais de cem vezes mais rápido."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na primeira vez que você calcular o quadragésimo número da sequência, serão feitas quarenta chamadas de função. Numa segunda vez que você calcular o mesmo número, será feita apenas uma chamada de função."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Diferença entre declare e def"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["declare"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-forward-declaration"]}]},{"tag":"text","content":[" poderíamos ter usado "]},{"tag":"monospaced","content":[{"tag":"text","content":["(def memo-fib)"]}]},{"tag":"text","content":[" no lugar da forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["declare"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A vantagem do "]},{"tag":"monospaced","content":[{"tag":"text","content":["declare"]}]},{"tag":"text","content":[" é que você pode fazer mais de uma declaração prematura de uma vez. Internamente será executado um "]},{"tag":"monospaced","content":[{"tag":"text","content":["def"]}]},{"tag":"text","content":[" para cada item."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; esse código"]},{"tag":"br","content":null},{"tag":"code-text","content":["(declare par impar primo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; faz a mesma coisa que esse"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def par)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def impar)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def primo)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como declarações prematuras não são uma coisa comum, e devem ser evitadas quando possível, dificilmente você precisará declarar mais de um "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" ao mesmo tempo."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/memoizado.png \"Grafo de chamadas de (memo-fib 5)\" label=diagrama-memoizado w=50%"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No diagrama da imagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["diagrama-memoizado"]}]},{"tag":"text","content":[" você pode ver a diferença ao calcularmos "]},{"tag":"monospaced","content":[{"tag":"text","content":["(fib 5)"]}]},{"tag":"text","content":[". Experimente comparar com o diagrama anterior."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Memoização para adultos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A implementação da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["memoize"]}]},{"tag":"text","content":[" é a mais simples possível, e existem situações em que ela se apresenta insuficiente ou inadequada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como fazer se você precisar que o valor memoizado tenha um prazo de validade?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um exemplo válido ocorre ao lermos um arquivo de configuração. Podemos ler o arquivo toda vez que algum processo precisar de uma configuração, o que é lento e perigoso, ou podemos ler apenas na primeira vez e memoizar o resultado para que todos os demais processos acessem a informação diretamente da memória de forma segura."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E se o arquivo de configuração for modificado? Teremos que reiniciar a aplicação toda vez que isso acontecer? Não temos como invalidar o valor memoizado para o arquivo seja lido novamente, mantendo sempre a informação mais recente em memória?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Com a implementação padrão da função "]},{"tag":"monospaced","content":[{"tag":"text","content":["meimoize"]}]},{"tag":"text","content":[" não temos muito o que fazer além de reiniciar a aplicação toda vez."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para evitar esse tipo de problema, que acaba sendo limitado a casos específicos, existe uma biblioteca chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["core.memoize"]}]},{"tag":"text","content":[", que pode ser encontrada em http://git.io/U2QLvA."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Caso você se pergunte porque não tornar o código dessa biblioteca como padrão do Clojure, eu te respondo. Simplesmente porque memoização é uma das formas de se resolver um tipo de problema específico e a biblioteca é uma forma específica de resolver um problema no problema específico. Seria complicar demais a biblioteca padrão para algo que deve responder por uma pequena fração da necessidade dos usuários."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Lembre-se que faz parte da filosofia por trás do desenvolvimento do Clojure que a biblioteca padrão permaneça simples e contendo somente o necessário, enquanto toda solução para problemas específicos ou complicados acaba ficando em pequenas bibliotecas que podem ser adicionados conforme a necessidade."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Assim você mantém a linguagem enxuta e sua aplicação carrega somente o peso que precisar carregar."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Recursão mútua com trampoline"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Recursão mútua acontece quando temos duas ou mais funções e uma depende da outra, e vice-versa."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["É um recurso que fica restrito a campos bem específicos, como por exemplo a criação de parsers, máquinas de estados finitos e fractais."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um exemplo de máquina de estados finitos bem conhecido é o semáforo de trânsito. No diagrama da imagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["diagrama-semaforo"]}]},{"tag":"text","content":[" temos os estados válidos de um semáforo e suas possíveis mudanças."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_04/semaforo.png \"Estados possíveis de um semáforo\" w=40% label=diagrama-semaforo"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em uma linguagem imperativa, normalmente teríamos um "]},{"tag":"italic","content":[{"tag":"text","content":["loop"]}]},{"tag":"text","content":[" com um "]},{"tag":"italic","content":[{"tag":"text","content":["if"]}]},{"tag":"text","content":[" ou um "]},{"tag":"italic","content":[{"tag":"text","content":["switch"]}]},{"tag":"text","content":[" invocando alguma função ou método de acordo com o estado atual do semáforo. Para isso teríamos um estado compartilhado entre os três blocos de código responsáveis por cada um dos estados."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em uma linguagem funcional podemos fazer com que cada função responsável pelo estado do semáforo guarde o estado atual, sem a necessidade de um estado global e compartilhado. Assim que houver a mudança no estado, que no nosso caso é a cor da luz, outra função é invocada e assim por diante."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-semaforo-1"]}]},{"tag":"text","content":[" vamos tentar implementar o semáforo seguindo as regras do diagrama da figura "]},{"tag":"ref-label","content":[{"tag":"text","content":["diagrama-semaforo"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Primeira versão do semáforo\" label=cap04-semaforo-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["(declare verde amarelo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn vermelho []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"vermelho\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 2000)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (verde))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn verde []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \" verde\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 2000)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (amarelo))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn amarelo []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"  amarelo\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (vermelho))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn semaforo []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (vermelho))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(semaforo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; vermelho"]},{"tag":"br","content":null},{"tag":"code-text","content":[";  verde"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   amarelo"]},{"tag":"br","content":null},{"tag":"code-text","content":["; vermelho"]},{"tag":"br","content":null},{"tag":"code-text","content":[";  verde"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ..."]},{"tag":"br","content":null},{"tag":"code-text","content":["; StackOverflowError   clojure.walk/stringify-keys/fn--6998"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código é bem simples. Ao chamarmos a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["semaforo"]}]},{"tag":"text","content":[", o semáforo começa a funcionar com a luz vermelha, depois de um tempo passa para verde, passa rapidamente para amarelo e acende a luz vermelha novamente. Apenas uma luz fica acesa por vez, e a ordem está sendo respeitada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O problema é que, depois de algum tempo, esse nosso código deixa de funcionar. A cada mudança de estado uma nova chamada de função é feita e uma posição no "]},{"tag":"italic","content":[{"tag":"text","content":["stack"]}]},{"tag":"text","content":[" do Java é consumida. Como o "]},{"tag":"italic","content":[{"tag":"text","content":["stack"]}]},{"tag":"text","content":[" tem um tamanho limitado, quando esse espaço acabar nossa aplicação será finalizada com uma mensagem de erro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Imagine se todos os semáforos da cidade parassem de funcionar depois de algumas horas, ou depois de poucos dias, por conta de um erro de programação."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso código, a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["vermelho"]}]},{"tag":"text","content":[" chama "]},{"tag":"monospaced","content":[{"tag":"text","content":["verde"]}]},{"tag":"text","content":[", que chama "]},{"tag":"monospaced","content":[{"tag":"text","content":["amarelo"]}]},{"tag":"text","content":[", que chama "]},{"tag":"monospaced","content":[{"tag":"text","content":["vermelho"]}]},{"tag":"text","content":[" novamente e o ciclo volta a se repetir. Temos aqui um caso de recursão mútua."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos resolver esse problema usando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["trampoline"]}]},{"tag":"text","content":[". Assim como vimos que a forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["recur"]}]},{"tag":"text","content":[" permite que usemos recursão sem estourar a pilha de chamadas do Java, "]},{"tag":"monospaced","content":[{"tag":"text","content":["trampoline"]}]},{"tag":"text","content":[" permite que façamos o mesmo usando recursão mútua."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Pulando de trampolim"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A título de curiosidade, a técnica recebeu o nome de "]},{"tag":"italic","content":[{"tag":"text","content":["trampolim"]}]},{"tag":"text","content":[" porque, internamente, consiste em fazer o fluxo da aplicação "]},{"tag":"italic","content":[{"tag":"text","content":["pular"]}]},{"tag":"text","content":[" de um lugar para o outro."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O segredo no uso de "]},{"tag":"monospaced","content":[{"tag":"text","content":["trampoline"]}]},{"tag":"text","content":[" está no fato de que cada função não mais vai chamar a próxima, mas retornar uma função que faz esse trabalho. Assim teremos "]},{"tag":"italic","content":[{"tag":"text","content":["uma função que devolve outra função"]}]},{"tag":"text","content":[" ao invés de termos "]},{"tag":"italic","content":[{"tag":"text","content":["uma função que chama outra função"]}]},{"tag":"text","content":[". Isso é a base de um recurso poderoso chamado "]},{"tag":"italic","content":[{"tag":"text","content":["lazy evaluation"]}]},{"tag":"text","content":[", que veremos em detalhes mais para frente."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando a forma reduzida "]},{"tag":"monospaced","content":[{"tag":"text","content":["#( )"]}]},{"tag":"text","content":[" para criarmos uma função anônima, faremos apenas alterações sutis no nosso código para que ele possa executar indefinidamente, sem consumir a pilha de chamadas."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-semaforo-2"]}]},{"tag":"text","content":[" nós temos o código modificado. Perceba que substituimos as chamadas de função por funções anônimas, e que a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["semaforo"]}]},{"tag":"text","content":[" agora executa "]},{"tag":"monospaced","content":[{"tag":"text","content":["trampoline vermelho"]}]},{"tag":"text","content":[" ao invés de chamar diretamente a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["vermelho"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Versão do semáforo que não consome a pilha\" label=cap04-semaforo-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(declare verde amarelo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn vermelho []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"vermelho\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 2000)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  #(verde))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn verde []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \" verde\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 2000)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  #(amarelo))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn amarelo []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"  amarelo\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (Thread/sleep 500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  #(vermelho))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn semaforo [])"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (trampoline vermelho))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(semaforo)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; vermelho"]},{"tag":"br","content":null},{"tag":"code-text","content":[";  verde"]},{"tag":"br","content":null},{"tag":"code-text","content":[";   amarelo"]},{"tag":"br","content":null},{"tag":"code-text","content":["; vermelho"]},{"tag":"br","content":null},{"tag":"code-text","content":[";  verde"]},{"tag":"br","content":null},{"tag":"code-text","content":["; ... e continua indefinidamente"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Composição de funções"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como dissemos no início do capítulo, numa linguagem funcional os dados são transformados por uma série de funções até que tenhamos o resultado que precisamos. O uso dessas séries de funções é chamada de "]},{"tag":"italic","content":[{"tag":"text","content":["composição"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando você compra um produto, é aplicada uma série de cálculos em cima de um valor base e, no final, você paga o valor que resultar dessa série. Podemos pensar em cada um desses cálculos como uma função, e na série toda como sendo a "]},{"tag":"italic","content":[{"tag":"text","content":["composição"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos imaginar que estamos comprando um computador. Simplificando muito a equação, vamos afirmar que a loja tenha 20% de margem de lucro, e que seja cobrado 10% de "]},{"tag":"italic","content":[{"tag":"text","content":["imposto genérico"]}]},{"tag":"text","content":[". O "]},{"tag":"italic","content":[{"tag":"text","content":["imposto genérico"]}]},{"tag":"text","content":[" é algo que só existe no nosso exemplo para que a coisa fique mais simples possível. No final, ainda tem um desconto de 2% porque pagamos à vista."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A fórmula de cálculo que vamos precisar é "]},{"tag":"monospaced","content":[{"tag":"text","content":["valorTotal = desconto(imposto(margem(valorBase)))"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos então criar o código em Clojure que calcula o nosso valor total:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def valor-base 1500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-margem [valor] (* valor 1.2))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-imposto [valor] (* valor 1.1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn desconto [valor] (* valor 0.98))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(desconto (adiciona-imposto (adiciona-margem valor-base)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Sabendo que o valor total de venda sempre vai ser a composição das funções "]},{"tag":"monospaced","content":[{"tag":"text","content":["desconto"]}]},{"tag":"text","content":[", "]},{"tag":"monospaced","content":[{"tag":"text","content":["adiciona-imposto"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["adiciona-margem"]}]},{"tag":"text","content":[", podemos juntar essa composição em apenas uma função."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["comp"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Como todas as funções recebem a mesma quantidade de parâmetros, podemos usar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["comp"]}]},{"tag":"text","content":[", que recebe as funções a serem agrupadas como parâmetro e devolve uma função que executa toda a sequência."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso código ficaria assim, usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["comp"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def valor-base 1500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-margem [valor] (* valor 1.2))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-imposto [valor] (* valor 1.1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn desconto [valor] (* valor 0.98))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def total (comp desconto adiciona-imposto adiciona-margem))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(total valor-base)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["comp"]}]},{"tag":"text","content":[" é uma boa alternativa para deixar o código mais limpo e também para evitarmos que ele se encha de parênteses."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando alguma das funções da composição tem uma quantidade diferente de parâmetros, podemos criar uma "]},{"tag":"italic","content":[{"tag":"text","content":["partial functions"]}]},{"tag":"text","content":[" para deixarmos o código uniforme."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos reaproveitar o nosso exemplo do contador de vogais para demonstrar como podemos utilizar "]},{"tag":"italic","content":[{"tag":"text","content":["partial"]}]},{"tag":"text","content":[" e composição em conjunto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Usando o "]},{"tag":"italic","content":[{"tag":"text","content":["set"]}]},{"tag":"text","content":[" "]},{"tag":"monospaced","content":[{"tag":"text","content":["vogal?"]}]},{"tag":"text","content":[" que já conhecemos, vamos usar um filtro para eliminar todas as letras que não sejam vogais para, no final, contarmos quantas letras sobraram."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def vogal? (set \"aeiouAEIOU\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def texto \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["(count (filter vogal? texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Mas já?"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Aí você diz: \"Puxa vida, mas eu escrevi aquela função grandona para contar vogais e agora você aparece com uma linha de código?\"."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Conforme você for se habituando a escrever código de maneira funcional, vai perceber que seus programas vão ficando menores e mais simples de entender."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos criar uma função parcial chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["filtra-vogais"]}]},{"tag":"text","content":[" que remove todas as letras do texto que não forem vogais. Assim como a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[" recebe apenas um parâmetro, nossa função parcial também vai trabalhar apenas com um argumento. Com as duas funções tendo a mesma aridade, fica fácil juntarmos tudo usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["comp"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def filtra-vogais (partial filter vogal?))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(count (filtra-vogais texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E agora podemos juntar "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["filtra-vogais"]}]},{"tag":"text","content":[" em uma função só:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def conta-vogais (comp count filtra-vogais))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(conta-vogais texto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Mas você, como um bom observador, vai se perguntar qual a vantagem disso quando temos uma composição de apenas duas funções. Vantagem nenhuma se isso só deixar seu código mais complicado. Porém, quando estamos trabalhando com aplicações de verdade, é comum você utilizar muitas funções em sequência, ou uma função que faz coisas demais."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nesses casos é muito útil quebrar a função que está muito grande em pedaços pequenos e altamente especializados, unindo-os com composição, ou então simular uma função grande compondo várias funções menores."]},{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Thread macros"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem casos em que simplesmente compor funções não é o suficiente. Se você tiver diversas funções com aridades diferentes, e não for reutilizar a função composta, criar várias funções parciais vai apenas tornar o código mais difícil de entender."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por outro lado, encadear muitas chamadas de função sem nenhuma macro ou função para ajudar vai fazer com que o código tenha parênteses demais."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["O significado de Thread"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A palavra "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"text","content":[", em seu sentido original, significa "]},{"tag":"italic","content":[{"tag":"text","content":["cordão"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["barbante"]}]},{"tag":"text","content":[". A palavra passou a ser utilizada em qualquer sentido que denote continuidade ou sequencia, ou simplesmente algo que vá de uma ponta à outra, como um cordão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure nós usamos o termo em dois casos distintos. O primeiro é quando falamos de "]},{"tag":"italic","content":[{"tag":"text","content":["thread macros"]}]},{"tag":"text","content":[", seja a "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":[" ou a "]},{"tag":"italic","content":[{"tag":"text","content":["thread last"]}]},{"tag":"text","content":[", que vamos ver a seguir. Esse nome indica que temos uma sequencia de operações sendo aplicadas em um dado inicial, sendo o resultado da primeira operação passada para a segunda, da segunda para a terceira e assim por diante, como em uma linha de montagem."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O segundo caso, muito mais conhecido, é quando falamos de "]},{"tag":"italic","content":[{"tag":"text","content":["thread"]}]},{"tag":"ref","content":[{"tag":"text","content":["thread-history"]}]},{"tag":"text","content":[" nos referindo a sequencias de processos"]},{"tag":"ref","content":[{"tag":"text","content":["dijkstra-thread"]}]},{"tag":"text","content":[" que são executados de forma paralela, ou quase, entre si. É o caso de termos "]},{"tag":"italic","content":[{"tag":"text","content":["duas ou mais threads sendo executadas simultaneamente"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-thread-0"]}]},{"tag":"text","content":[" vamos relembrar o cálculo do valor total do produto, com os impostos, lucro e descontos. O valor base é "]},{"tag":"italic","content":[{"tag":"text","content":["1500"]}]},{"tag":"text","content":[" e o valor final é "]},{"tag":"monospaced","content":[{"tag":"text","content":["1940.4"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Cálculo do preço total pelo jeito longo\" label=cap04-thread-0"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def valor-base 1500)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-margem [valor] (* valor 1.2))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn adiciona-imposto [valor] (* valor 1.1))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defn desconto [valor] (* valor 0.98))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(desconto (adiciona-imposto (adiciona-margem valor-base)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A cada nova operação que adicionarmos no cálculo, teremos que que adicionar a função no começo da expressão e o parêntese correspondente no final. Não há nada de errado nisso, mas com o tempo começa a ficar difícil se encontrar no meio dos parênteses sem a ajuda de um editor de texto que ajude nesse ponto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos adicionar um cálculo qualquer de envio pelo correio, que vamos chamar de "]},{"tag":"monospaced","content":[{"tag":"text","content":["frete"]}]},{"tag":"text","content":[", e o código vai ficar assim:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(frete (desconto (adiciona-imposto (adiciona-margem valor-base))))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A expressão começa a ficar mais longa e mais difícil de manter."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para ajudar a reduzir esse aumento de complexidade, o Clojure oferece os operadores conhecidos por "]},{"tag":"italic","content":[{"tag":"text","content":["thread macros"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["->"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Thread first"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O primeiro deles é o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[", chamado de "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Com o "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":[" você informa o valor inicial a ser transformado, que no nosso cálculo é o "]},{"tag":"monospaced","content":[{"tag":"text","content":["valor-base"]}]},{"tag":"text","content":[". Em seguida informa a primeira função que vai transformar o valor, depois a segunda, a terceira, e assim por diante. O resultado da primeira função é passado como parâmetro para a segunda, cujo resultado é passado para a terceira, até que acabe a lista de operações. No final você recebe o valor."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos demonstrar passo a passo como funciona o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[". Primeiro informamos o valor inicial a ser transformado:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1500"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos aplicar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["adiciona-margem"]}]},{"tag":"text","content":[" em cima desses "]},{"tag":"italic","content":[{"tag":"text","content":["1500"]}]},{"tag":"text","content":[" referentes ao valor base:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1800"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos adicionar os impostos usando a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["adiciona-imposto"]}]},{"tag":"text","content":[". Essa função vai receber como parâmetro o valor de "]},{"tag":"italic","content":[{"tag":"text","content":["1800"]}]},{"tag":"text","content":[" que conseguimos até aqui."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-imposto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1980"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E assim por diante, até chegarmos ao cálculo do desconto. Vamos aproveitar para comparar o jeito que o código ficou usando "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":[" com o jeito anterior, aninhando as expressões:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Código completo usando ->\" label=cap04-thread-1"]},{"tag":"br","content":null},{"tag":"code-text","content":["; cálculo utilizando ->"]},{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-imposto"]},{"tag":"br","content":null},{"tag":"code-text","content":["    desconto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null},{"tag":"code-text","content":["; cálculo do jeito longo"]},{"tag":"br","content":null},{"tag":"code-text","content":["(desconto (adiciona-imposto (adiciona-margem valor-base)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No final, chegamos ao mesmo valor de "]},{"tag":"monospaced","content":[{"tag":"text","content":["1940.4"]}]},{"tag":"text","content":[", mas de uma forma bem mais organizada. A cada nova operação que quisermos acrescentar ao processo, basta ir adicionando função por função, na ordem, ao final da lista."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" é chamado de "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":[" porque insere o resultado do passo anterior como primeiro parâmetro do passo seguinte. Essa sequencia de passos para transformar um valor também é conhecida por "]},{"tag":"italic","content":[{"tag":"text","content":["pipeline"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Nosso exemplo foi bem simples. Todas as funções recebem apenas um argumento. E quando a função recebe dois ou mais?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos pensar em uma expressão matemática simples, apenas para exemplificar o funcionamento. Vamos escrever a expressão "]},{"tag":"monospaced","content":[{"tag":"text","content":["((((2 + 3) * 4) - 5) / 6)"]}]},{"tag":"text","content":[" da forma normal e, em seguida vamos escrever da forma reduzida usando o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; cálculo do jeito longo"]},{"tag":"br","content":null},{"tag":"code-text","content":["(/ (- (* (+ 2 3) 4) 5) 6)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 5/2"]},{"tag":"br","content":null},{"tag":"code-text","content":["; cálculo usando ->"]},{"tag":"br","content":null},{"tag":"code-text","content":["(-> 2 (+ 3) (* 4) (- 5) (/ 6))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 5/2"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["De onde surgiu esse "]},{"tag":"monospaced","content":[{"tag":"text","content":["5/2"]}]},{"tag":"text","content":["?"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure existem três tipos numéricos básicos: inteiros, decimais e racionais."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["BigDecimal"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Os números decimais são aqueles a que já estamos acostumados, no formato "]},{"tag":"monospaced","content":[{"tag":"text","content":["2.5"]}]},{"tag":"text","content":[" e internamente utilizando a classe "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.lang.Double"]}]},{"tag":"text","content":[" do Java."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Ratio"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já os tipos racionais são apresentados na forma "]},{"tag":"monospaced","content":[{"tag":"text","content":["5/2"]}]},{"tag":"text","content":[" e são retornados sempre que uma divisão não resulta em um número inteiro. Internamente usa-se o tipo "]},{"tag":"monospaced","content":[{"tag":"text","content":["Ratio"]}]},{"tag":"text","content":[" para representar esse tipo numérico."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No próximo capítulo serão apresentados mais detalhes sobre esse tipo e a motivação para que ele exista."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Avaliando passo a passo a expressão que criamos com "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[", vamos pegar o primeiro item da lista, que é "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":[", e passá-lo como primeiro parâmetro para o segundo item, "]},{"tag":"monospaced","content":[{"tag":"text","content":["(+ 3)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O resultado, "]},{"tag":"monospaced","content":[{"tag":"text","content":["(+ 2 3)"]}]},{"tag":"text","content":[" é passado como primeiro parâmetro para o próximo item da lista, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(* 4)"]}]},{"tag":"text","content":[", se transformando internamente em "]},{"tag":"monospaced","content":[{"tag":"text","content":["(* (+ 2 3) 4)"]}]},{"tag":"text","content":[", que vai ser passado como o primeiro parâmetro do item seguinte, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(- 5)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Com isso temos a expressão "]},{"tag":"monospaced","content":[{"tag":"text","content":["(- (* (+ 2 3) 4) 5)"]}]},{"tag":"text","content":[", que vai ser passada como o primeiro parâmetro do último item da lista, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(/ 6)"]}]},{"tag":"text","content":[", resultado na expressão em seu formato normal, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(/ (- (* (+ 2 3) 4) 5) 6)"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Acessando mapas com thread first"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" nos permite acessar mapas de forma bem mais simples. Na listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-thread-2"]}]},{"tag":"text","content":[", vamos relembrar do mapa que usamos ao falar sobre "]},{"tag":"italic","content":[{"tag":"text","content":["destructuring"]}]},{"tag":"text","content":[". Esse mapa contém os dados de um livro qualquer e vamos demonstrar como extrair informações utilizando o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"text","content":[" \"Mapa com os dados de um livro qualquer\" label=cap04-thread-2"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def info-livro"]},{"tag":"br","content":null},{"tag":"code-text","content":["        {:titulo \"Livro de Clojure\""]},{"tag":"br","content":null},{"tag":"code-text","content":["         :autor \"Plínio Balduino\""]},{"tag":"br","content":null},{"tag":"code-text","content":["         :capitulos {:capitulo01 \"Apresentação\""]},{"tag":"br","content":null},{"tag":"code-text","content":["                     :capitulo02 \"Uma introdução gentil ao Clojure\"}})"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Se quisermos extrair o título do capítulo 2, precisaremos acessar a propriedade "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulos"]}]},{"tag":"text","content":[" e, com o resultado, acessar a propriedade "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulo02"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; :capitulos guarda um mapa"]},{"tag":"br","content":null},{"tag":"code-text","content":["(info-livro :capitulos)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; {:capitulo01 \"Apresentação\","]},{"tag":"br","content":null},{"tag":"code-text","content":[";  :capitulo02 \"Uma introdução gentil ao Clojure\"}"]},{"tag":"br","content":null},{"tag":"code-text","content":["; e acessando :capitulo02, temos o título"]},{"tag":"br","content":null},{"tag":"code-text","content":["((info-livro :capitulos) :capitulo02)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Uma introdução gentil ao Clojure\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Da mesma forma que, quando maior a expressão, maior a quantidade de parênteses, acontece o mesmo com mapas, onde quanto mais a fundo você precisar ir em um mapa para encontrar a informação, mais difícil de ler fica a expressão."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["De forma parecida, para acessarmos uma informação de um mapa, vamos passar o nome do mapa como primeiro parâmetro para o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> info-livro)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; {:titulo \"Livro de Clojure\","]},{"tag":"br","content":null},{"tag":"code-text","content":["; :capitulos {:capitulo01 \"Apresentação\","]},{"tag":"br","content":null},{"tag":"code-text","content":[";             :capitulo02 \"Uma introdução gentil ao Clojure\"},"]},{"tag":"br","content":null},{"tag":"code-text","content":["; :autor \"Plínio Balduino\"}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em seguida adicionamos na lista de parâmetros a chave do primeiro nível da informação, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["capítulos"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> info-livro"]},{"tag":"br","content":null},{"tag":"code-text","content":["    :capitulos)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; {:capitulo01 \"Apresentação\","]},{"tag":"br","content":null},{"tag":"code-text","content":[";  :capitulo02 \"Uma introdução gentil ao Clojure\"}"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E, finalmente, informamos a chave que contém o próximo nível de informação, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":[":capitulo02"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> info-livro"]},{"tag":"br","content":null},{"tag":"code-text","content":["    :capitulos"]},{"tag":"br","content":null},{"tag":"code-text","content":["    :capitulo02)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Uma introdução gentil ao Clojure\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dessa forma, podemos buscar dados em mapas grandes de forma fácil de entender e de manter."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Thread last"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["->>"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":[", conhecido por "]},{"tag":"italic","content":[{"tag":"text","content":["thread last"]}]},{"tag":"text","content":[", funciona de forma muito parecida com o "]},{"tag":"italic","content":[{"tag":"text","content":["thread first"]}]},{"tag":"text","content":[", pegando o primeiro parâmetro e usando como parâmetro do segundo, e assim por diante. A diferença é que esse parâmetro é usado como último argumento do próximo item da lista."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos usar uma expressão matemática para exemplificar. Sempre achei que exemplos práticos são a melhor maneira de se entender uma funcionalidade."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; Cálculo da forma normal"]},{"tag":"br","content":null},{"tag":"code-text","content":["(/ 6 (- 5 (* 4 (+ 3 2))))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -2/5"]},{"tag":"br","content":null},{"tag":"code-text","content":["; E o mesmo cálculo usando ->>"]},{"tag":"br","content":null},{"tag":"code-text","content":["(->> 2 (+ 3) (* 4) (- 5) (/ 6))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; -2/5"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Internamente, o primeiro valor, "]},{"tag":"italic","content":[{"tag":"text","content":["2"]}]},{"tag":"text","content":[", vai ser passado como o último parâmetro da próxima expressão, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(+ 3)"]}]},{"tag":"text","content":[", resultando em "]},{"tag":"monospaced","content":[{"tag":"text","content":["(+ 3 2)"]}]},{"tag":"text","content":[". Esse resultado é usado como o último parâmetro da expressão seguinte, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(* 4)"]}]},{"tag":"text","content":[" e com isso temos "]},{"tag":"monospaced","content":[{"tag":"text","content":["(* 4 (+ 3 2))"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Depois o resultado é usado com a expressão "]},{"tag":"monospaced","content":[{"tag":"text","content":["(- 5)"]}]},{"tag":"text","content":[", resultando em "]},{"tag":"monospaced","content":[{"tag":"text","content":["(- 5 (* 4 (+ 3 2)))"]}]},{"tag":"text","content":[" e com o último item, "]},{"tag":"monospaced","content":[{"tag":"text","content":["(/ 6)"]}]},{"tag":"text","content":[", resultando na expressão original, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(/ 6 (- 5 (* 4 (+ 3 2))))"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos encerrar reescrevendo aquele nosso código que conta as vogais. Primeiro criamos uma função recursiva e depois resolvemos o mesmo problema usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["filter"]}]},{"tag":"text","content":[". Agora vamos reescrever o código usando "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Eis o código que escrevemos quando estávamos aprendendo composição de funções:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def vogal? (set \"aeiouAEIOU\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(def texto \"Livro de Clojure\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["(count (filter vogal? texto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para reescrever esse código usando "]},{"tag":"italic","content":[{"tag":"text","content":["thread last"]}]},{"tag":"text","content":[", primeiro pegamos o último parâmetro da expressão que estiver mais aninhada, que é "]},{"tag":"monospaced","content":[{"tag":"text","content":["(filter vogal? texto)"]}]},{"tag":"text","content":[", e passamos como parâmetro para o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":[". Em seguida adicionamos o restante da expressão que estiver mais aninhada:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(->> texto"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (filter vogal?))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; (\\i \\o \\e \\o \\u \\e)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Um pequeno detalhe sobre -> e ->>"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Enquanto o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" permite que você passe apenas um parâmetro, o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":[" exige que pelo menos dois argumentos sejam utilizados."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Não sei dizer se isso é intencional ou um pequeno detalhe que passou em branco."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora que temos a lista de vogais que estão no texto, vamos aplicar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[" para sabermos quantos são:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(->> texto"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (filter vogal?)"]},{"tag":"br","content":null},{"tag":"code-text","content":["     count)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E finalmente temos a quantidade de vogais contida em nosso texto, de forma mais legível e simples de manter."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um leitor mais atento vai perceber que, enquanto usamos parênteses para delimitar a expressão "]},{"tag":"monospaced","content":[{"tag":"text","content":["(filter vogal?)"]}]},{"tag":"text","content":[", não usamos para delimitar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Percebendo isso, será inevitável que faça a pergunta a respeito de quando se deve usar ou não os parênteses com os operadores "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A resposta é bem simples. Sempre que a expressão for formada por uma função contendo parâmetros, como é o caso de "]},{"tag":"monospaced","content":[{"tag":"text","content":["(filter vogal?)"]}]},{"tag":"text","content":[", você deve usar parênteses para que o compilador saiba onde ela começa e onde termina."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Quando você estiver usando uma função que não recebe nenhum parâmetro adicional, como é o caso de "]},{"tag":"monospaced","content":[{"tag":"text","content":["count"]}]},{"tag":"text","content":[", fica a seu critério usar ou não parênteses."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por exemplo, ambos os códigos abaixo funcionam da mesma forma:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; Esse código"]},{"tag":"br","content":null},{"tag":"code-text","content":["(->> texto"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (filter vogal?)"]},{"tag":"br","content":null},{"tag":"code-text","content":["     count)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null},{"tag":"code-text","content":["; é equivalente a esse"]},{"tag":"br","content":null},{"tag":"code-text","content":["(->> texto"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (filter vogal?)"]},{"tag":"br","content":null},{"tag":"code-text","content":["     (count))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Da mesma forma que o nosso exemplo da listagem "]},{"tag":"ref-label","content":[{"tag":"text","content":["cap04-thread-1"]}]},{"tag":"text","content":[" pode ser escrita das duas formas abaixo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["; Esse código"]},{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-imposto"]},{"tag":"br","content":null},{"tag":"code-text","content":["    nil"]},{"tag":"br","content":null},{"tag":"code-text","content":["    desconto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null},{"tag":"code-text","content":["; é equivalente a esse"]},{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (adiciona-margem)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (adiciona-imposto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (desconto))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; 1940.4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Sendo que a segunda forma é discutivelmente mais difícil de ser lida."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Lidando com valores nulos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["E se, em algum momento, um dos passos da transformação retornar "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":["?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos inventar uma função chamada "]},{"tag":"monospaced","content":[{"tag":"text","content":["nulo"]}]},{"tag":"text","content":[", que nada mais faz do que retornar o valor "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":[". Imagine que essa função precise acessar um banco de dados, um site, e por qualquer motivo acabe retornando um valor nulo."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn nulo [valor])"]},{"tag":"br","content":null},{"tag":"code-text","content":["(nulo 123)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; nil"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A função "]},{"tag":"monospaced","content":[{"tag":"text","content":["nulo"]}]},{"tag":"text","content":[" não retorna nada, o que é entendido como "]},{"tag":"monospaced","content":[{"tag":"text","content":["nil"]}]},{"tag":"text","content":[" pelo Clojure."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos adicionar essa função "]},{"tag":"monospaced","content":[{"tag":"text","content":["nulo"]}]},{"tag":"text","content":[" no meio do nosso cálculo de preço:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-imposto"]},{"tag":"br","content":null},{"tag":"code-text","content":["    nulo"]},{"tag":"br","content":null},{"tag":"code-text","content":["    desconto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; NullPointerException   clojure.lang.Numbers.multiply"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["some->"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A partir da versão 1.5 do Clojure, passamos a contar com a macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["some->"]}]},{"tag":"text","content":[", que interrompe o processamento assim que um valor nulo é encontrado. Ai fica por sua conta devolver uma mensagem de erro para o usuário ou retornar zero como o valor do produto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Qualquer que seja a sua estratégia, ainda será melhor do que explodir um erro na cara do usuário ou a aplicação parar de funcionar por conta de um erro não tratado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos alterar nosso código para utilizar a macro "]},{"tag":"monospaced","content":[{"tag":"text","content":["some->"]}]},{"tag":"text","content":[":"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(some-> valor-base"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-margem"]},{"tag":"br","content":null},{"tag":"code-text","content":["    adiciona-imposto"]},{"tag":"br","content":null},{"tag":"code-text","content":["    nulo"]},{"tag":"br","content":null},{"tag":"code-text","content":["    desconto)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; nil"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Da mesma forma como existem os operadores "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":[", também existe o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["some->>"]}]},{"tag":"text","content":[" além do "]},{"tag":"monospaced","content":[{"tag":"text","content":["some->"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O funcionamento de "]},{"tag":"monospaced","content":[{"tag":"text","content":["some->>"]}]},{"tag":"text","content":[" é idêntico ao "]},{"tag":"monospaced","content":[{"tag":"text","content":["->>"]}]},{"tag":"text","content":[", mas finalizando o processamento assim que um valor nulo for encontrado."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Multimethods"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Polimorfismo com multimethods"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Há alguns anos trabalhei em um servidor escrito em Java que recebia o nome do serviço como texto e invocava o método correspondente após validar a sessão do usuário."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A classe que fazia essa distribuição de trabalho chegou a ter mais de mil e quinhentas linhas de código. Era difícil de manter, difícil de testar e, além de tudo, era bem feio."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em Clojure teríamos algo com essa cara:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defn dispatcher [{service-name :service-name"]},{"tag":"br","content":null},{"tag":"code-text","content":["                   parameters   :parameters}]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (cond"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (= service-name \"activate-product\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (println \"Ativando produto\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (= service-name \"upload-data\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (println \"Enviando dados\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["    :else"]},{"tag":"br","content":null},{"tag":"code-text","content":["      (println \"Serviço não encontrado:\" service-name)))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para executar a função, passarímos os dados da requisição em um "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"activate-product\""]},{"tag":"br","content":null},{"tag":"code-text","content":["             :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ativando produto"]},{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"desconhecido\""]},{"tag":"br","content":null},{"tag":"code-text","content":["             :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Serviço não encontrado: desconhecido"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma alternativa encontrada foi quebrar o código em pequenas classes, informando o nome do serviço correspondente em uma anotação. Uma outra classe pesquisava em tempo de execução pelo serviço que estava sendo invocado e executava a classe correta."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Reflection"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O código ficou mais fácil de testar, mais simples de dar manutenção, mas ficou com cheiro de mágica, uma vez que foi feito uso pesado de "]},{"tag":"italic","content":[{"tag":"text","content":["reflection"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Reflection"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["De acordo com a documentação do Java"]},{"tag":"ref","content":[{"tag":"text","content":["reflect-tutorial"]}]},{"tag":"text","content":[", "]},{"tag":"italic","content":[{"tag":"text","content":["reflection"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["reflexão"]}]},{"tag":"text","content":[", é normalmente utilizado por programas que necessitam examinar ou modificar o comportamento em tempo de execução."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Reflection"]}]},{"tag":"text","content":[" é uma forma de utilizarmos metaprogramação em Java, ou seja, uma forma de manipularmos e acessarmos detalhes do programa enquanto ele está sendo executado. Vamos ver isso na prática ao aprendermos sobre integração com Java e "]},{"tag":"italic","content":[{"tag":"text","content":["reader macros"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Dispatch, dynamic"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Dispatch, runtime"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Esse tipo de abordagem, quando o método a ser executado é definido em tempo de execução, é chamado "]},{"tag":"italic","content":[{"tag":"text","content":["dynamic dispatch"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["runtime dispatch"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Runtime polymorphism"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Felizmente em Clojure é possível resolver esse problema sem apelar para gambiarras através de "]},{"tag":"italic","content":[{"tag":"text","content":["polimorfismo em tempo de execução"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["runtime polymorphism"]}]},{"tag":"text","content":[" no original em Inglês."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Multiple dispatch"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Dispatch, multiple"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Uma das formas de implementar esse tipo de polimorfismo é utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["multiple dispatch"]}]},{"tag":"text","content":[", que nada mais é do que um nome bonito para a definição em tempo de execução para qual código será executado de acordo com parâmetros pré-definidos. Exatamente o que foi feito naquele servidor Java usando truques de metaprogramação."]},{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Multiple dispatch"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Não existe uma tradução decente para o termo, então preferi manter assim mesmo. Você deve concordar comigo que "]},{"tag":"italic","content":[{"tag":"text","content":["despachos múltiplos"]}]},{"tag":"text","content":[" não faria muito sentido."]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No Clojure o recurso de "]},{"tag":"italic","content":[{"tag":"text","content":["multiple dispatch"]}]},{"tag":"text","content":[" aparece na forma de "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":[". É uma das formas que a linguagem utiliza para implementar polimorfismo, aquele conceito tão conhecido das linguagens orientadas a objeto."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Com ele, o nosso exemplo do servidor ficaria bem mais simples e legível."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["defmulti"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Primeiro devemos definir uma função de "]},{"tag":"italic","content":[{"tag":"text","content":["dispatch"]}]},{"tag":"text","content":[" através do operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["defmulti"]}]},{"tag":"text","content":[". Função de "]},{"tag":"italic","content":[{"tag":"text","content":["dispatch"]}]},{"tag":"text","content":[" é aquela que "]},{"tag":"italic","content":[{"tag":"text","content":["despacha as requisições"]}]},{"tag":"text","content":[", ou seja, delega a responsabilidade a determinado trecho de código de acordo com os valores recebidos."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O primeiro parâmetro é o próprio nome da função de "]},{"tag":"italic","content":[{"tag":"text","content":["dispatch"]}]},{"tag":"text","content":[", enquanto o segundo parâmetro é a função que vai tratar os dados recebidos. Caso você esteja trabalhando com um "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[", pode também informar a chave que vai conter a informação necessária para invocar o método correto. No próximo capítulo vamos ver em detalhes como funciona um "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[" e suas respectivas chaves."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos usar uma chave de um "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[" no nosso exemplo."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defmulti dispatcher :service-name)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Aqui criamos um "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["dispatcher"]}]},{"tag":"text","content":[", que vai usar o valor indicado pela chave "]},{"tag":"monospaced","content":[{"tag":"text","content":[":service-name"]}]},{"tag":"text","content":[" no "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[" que será passado como parâmetro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos criar os métodos que serão executados de acordo com o valor contido no "]},{"tag":"italic","content":[{"tag":"text","content":["hashmap"]}]},{"tag":"text","content":[". Métodos são funções especiais invocadas pelo "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["defmethod"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para criar um método, você deve usar o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["defmethod"]}]},{"tag":"text","content":[", passando como argumentos o nome da função de "]},{"tag":"italic","content":[{"tag":"text","content":["dispatch"]}]},{"tag":"text","content":[", que é o mesmo que você usou com "]},{"tag":"monospaced","content":[{"tag":"text","content":["defmulti"]}]},{"tag":"text","content":[", o valor que vai definir se aquele método vai ser executado e o parâmetro que o método vai receber."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No nosso caso, o valor que define se o método vai ser executado é o nome do serviço, em formato texto mesmo."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod dispatcher \"activate-product\" [request]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Ativando produto\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod dispatcher \"upload-data\" [request]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Enviando dados\"))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para executar o nosso "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":[", o código continua exatamente o mesmo:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"activate-product\""]},{"tag":"br","content":null},{"tag":"code-text","content":["           :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Ativando produto"]},{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"upload-data\""]},{"tag":"br","content":null},{"tag":"code-text","content":["           :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Enviando dados"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Porém, ao tentarmos invocar algum serviço que não tem um método associado, receberemos uma mensagem de erro:"]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"desconhecido\""]},{"tag":"br","content":null},{"tag":"code-text","content":["           :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; IllegalArgumentException No method in multimethod 'dispatcher'"]},{"tag":"br","content":null},{"tag":"code-text","content":["; for dispatch value: desconhecido"]},{"tag":"br","content":null},{"tag":"code-text","content":["; clojure.lang.MultiFn.getFn (MultiFn.java:160)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["multimethod :default"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Para resolver isso basta criarmos um método padrão, que recebe todas as requisições que não encontrarem um método. Basta utilizarmos o valor "]},{"tag":"monospaced","content":[{"tag":"text","content":[":default"]}]},{"tag":"text","content":[" como critério e tudo volta a funcionar."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod dispatcher :default [request]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Serviço não encontrado:\""]},{"tag":"br","content":null},{"tag":"code-text","content":["           (:service-name request)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"desconhecido\""]},{"tag":"br","content":null},{"tag":"code-text","content":["             :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Serviço não encontrado: desconhecido"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora, imagine que "]},{"tag":"monospaced","content":[{"tag":"text","content":[":default"]}]},{"tag":"text","content":[" já seja um valor válido na sua aplicação e você queira que o Clojure saia da sua frente e pare de atrapalhar. Teria como fazer o método padrão enxergar outro valor?"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Sim, felizmente isso é possível. Basta mudarmos um pouco a declaração do "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":[" informando o valor padrão."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defmulti dispatcher :service-name :default :nao-encontrado)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod dispatcher :nao-encontrado [request]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"Serviço não encontrado:\""]},{"tag":"br","content":null},{"tag":"code-text","content":["           (:service-name request)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(dispatcher {:service-name \"desconhecido\""]},{"tag":"br","content":null},{"tag":"code-text","content":["             :parameters 123})"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Serviço não encontrado: desconhecido"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A melhor ferramenta é aquela que não atrapalha o seu trabalho."]},{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["Overloading com tipos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["static dispatch"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Imagine agora que você tenha que invocar métodos diferentes de acordo com o tipo do parâmetro. No Java basta mudarmos a assinatura do método e o próprio compilador resolve a questão. Esse caso, em que o compilador define quem vai ser executado, é chamado de "]},{"tag":"italic","content":[{"tag":"text","content":["static dispatch"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["java",{"tag":"br","content":null},{"tag":"code-text","content":["public class OverloadPorTipo {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public static void qualTipo(String valor) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"É String\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public static void qualTipo(Number valor) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"É um número\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["  public static void qualTipo(Object valor) {"]},{"tag":"br","content":null},{"tag":"code-text","content":["    System.out.println(\"É um objeto\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["  }"]},{"tag":"br","content":null},{"tag":"code-text","content":["}"]},{"tag":"br","content":null},{"tag":"code-text","content":["OverloadPorTipo.qualTipo(\"Texto\");"]},{"tag":"br","content":null},{"tag":"code-text","content":["// É String"]},{"tag":"br","content":null},{"tag":"code-text","content":["OverloadPorTipo.qualTipo(3.14);"]},{"tag":"br","content":null},{"tag":"code-text","content":["// É um número"]},{"tag":"br","content":null},{"tag":"code-text","content":["OverloadPorTipo.qualTipo(Boolean.TRUE);"]},{"tag":"br","content":null},{"tag":"code-text","content":["// É um objeto"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Podemos chegar ao mesmo utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["multimethods"]}]},{"tag":"text","content":[" que faz uso de "]},{"tag":"italic","content":[{"tag":"text","content":["dynamic dispatch"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["JavaREPL"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"box","content":[{"tag":"text","content":["Testando código Java"]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Você pode usar o "]},{"tag":"italic","content":[{"tag":"text","content":["JavaREPL"]}]},{"tag":"text","content":[" para testar códigos Java curtos, sem a necessidade de abrir um IDE."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["http://www.javarepl.com/"]},{"tag":"br","content":null}]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["class"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Lembrando que na declaração do "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":[" você informa a função que vai retornar o valor usado como critério, vamos utilizar a função "]},{"tag":"monospaced","content":[{"tag":"text","content":["class"]}]},{"tag":"text","content":[", que retorna a classe do valor recebido."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defmulti qual-tipo class)"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod qual-tipo java.lang.String [valor]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"É String\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod qual-tipo java.lang.Number [valor]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"É um número\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(defmethod qual-tipo java.lang.Object [valor]"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (println \"É um objeto\"))"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos executar o nosso código. Note como ficou parecido com as chamadas do Java."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(qual-tipo \"Texto\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; É String"]},{"tag":"br","content":null},{"tag":"code-text","content":["(qual-tipo 3.14)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; É um número"]},{"tag":"br","content":null},{"tag":"code-text","content":["(qual-tipo Boolean/TRUE)"]},{"tag":"br","content":null},{"tag":"code-text","content":["; É um objeto"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Protocolos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"section","content":[{"tag":"text","content":["Polimorfismo com protocolos"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Protocolos são um conjunto de funções que seguem uma regra predefinida."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["É como se você tivesse uma versão Clojure das interfaces do Java, onde você precisa implementar um conjunto mínimo métodos para que o seu objeto seja aceito, mas essa implementação fica por sua conta."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Dessa forma, podemos passar a implementação de um protocolo para uma função, que vai poder executar um conjunto de operações com ele sem medo de que a operação não saiba como lidar com o tipo de dado."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Expression problem"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Além do mais, o uso de protocolos permite que você estenda e complemente tipos já existentes, resolvendo assim um problema conhecido como "]},{"tag":"italic","content":[{"tag":"text","content":["expression problem"]}]},{"tag":"text","content":["."]},{"tag":"ref","content":[{"tag":"text","content":["expression-problem"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Resumidamente, um "]},{"tag":"italic","content":[{"tag":"text","content":["expression problem"]}]},{"tag":"text","content":[" é um tipo de problema que não pode ser resolvido facilmente com Programação Funcional ou com Orientação a Objetos ao mesmo tempo"]},{"tag":"ref","content":[{"tag":"text","content":["expression-problem-lammel"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em uma linguagem puramente funcional podemos facilmente adicionar código que trabalhe com dados sem a necessidade de alterar o código já existente, mas não conseguimos alterar os tipos já existentes sem modificar o código"]},{"tag":"ref","content":[{"tag":"text","content":["expression-problem-fowler"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_08/expression-problem-fp.png \"Na Programação Funcional é fácil adicionar funcionalidades\" w=80% label=expression-problem-fp"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por outro lado, em uma linguagem puramente orientada a objetos, podemos criar novos tipos de dados facilmente, mas não conseguimos adicionar funcionalidades ao código atual sem alterá-lo."]},{"tag":"br","content":null}]},{"tag":"img","content":[{"tag":"text","content":["images/capitulo_08/expression-problem-oop.png \"Na Orientação a Objetos é fácil adicionar tipos\" w=80% label=expression-problem-oop"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Open classes"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Monkey patching"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["No Ruby esse problema é resolvido utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["open classes"]}]},{"tag":"text","content":[", que é a habilidade de permitir que alteremos classes já existentes sem alterar o código que existe hoje. Essas alterações são chamadas de "]},{"tag":"italic","content":[{"tag":"text","content":["monkey patching"]}]},{"tag":"ref","content":[{"tag":"text","content":["ruby-lucas"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Por exemplo, todo texto é uma instância da classe "]},{"tag":"monospaced","content":[{"tag":"text","content":["String"]}]},{"tag":"text","content":[". Se quisermos saber quantas palavras tem um texto de uma maneira que toda "]},{"tag":"monospaced","content":[{"tag":"text","content":["String"]}]},{"tag":"text","content":[" tenha essa funcionalidade, basta adicionarmos o método diretamente na classe e automaticamente todo o nosso código terá acesso a ele."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos chamar nosso método de "]},{"tag":"monospaced","content":[{"tag":"text","content":["count_words"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"code","content":["ruby",{"tag":"br","content":null},{"tag":"code-text","content":["frase = \"Meu cavalo come abobora\""]},{"tag":"br","content":null},{"tag":"code-text","content":["frase.class"]},{"tag":"br","content":null},{"tag":"code-text","content":["# String"]},{"tag":"br","content":null},{"tag":"code-text","content":["frase.count_words"]},{"tag":"br","content":null},{"tag":"code-text","content":["# NoMethodError: undefined method `count_words' for"]},{"tag":"br","content":null},{"tag":"code-text","content":["# \"Meu cavalo come abobora\":String"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O método "]},{"tag":"monospaced","content":[{"tag":"text","content":["count_words"]}]},{"tag":"text","content":[" não existe na implementação padrão da classe "]},{"tag":"monospaced","content":[{"tag":"text","content":["String"]}]},{"tag":"text","content":[", então vamos adicioná-lo."]},{"tag":"br","content":null}]},{"tag":"code","content":["ruby",{"tag":"br","content":null},{"tag":"code-text","content":["class String"]},{"tag":"br","content":null},{"tag":"code-text","content":["  def count_words"]},{"tag":"br","content":null},{"tag":"code-text","content":["    self.split(\" \").count"]},{"tag":"br","content":null},{"tag":"code-text","content":["  end"]},{"tag":"br","content":null},{"tag":"code-text","content":["end"]},{"tag":"br","content":null},{"tag":"code-text","content":["frase.count_words"]},{"tag":"br","content":null},{"tag":"code-text","content":["# 4"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos tentar com um texto que não existia quando adicionamos o método:"]},{"tag":"br","content":null}]},{"tag":"code","content":["ruby",{"tag":"br","content":null},{"tag":"code-text","content":["\"Essa frase eh nova em folha\".count_words"]},{"tag":"br","content":null},{"tag":"code-text","content":["# 6"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Já JavaScript resolve isso utilizando "]},{"tag":"italic","content":[{"tag":"text","content":["prototipação"]}]},{"tag":"text","content":[", que é a forma como a linguagem implementa Orientação a Objetos sem a necessidade de utilizar classes."]},{"tag":"br","content":null}]},{"tag":"code","content":["javascript",{"tag":"br","content":null},{"tag":"code-text","content":["var frase = \"Meu cavalo come abóbora\";"]},{"tag":"br","content":null},{"tag":"code-text","content":["typeof frase"]},{"tag":"br","content":null},{"tag":"code-text","content":["// \"string\""]},{"tag":"br","content":null},{"tag":"code-text","content":["frase.countWords();"]},{"tag":"br","content":null},{"tag":"code-text","content":["// VM417:2 Uncaught TypeError: frase.countWords is not a function"]},{"tag":"br","content":null},{"tag":"code-text","content":["// (anonymous function)"]},{"tag":"br","content":null},{"tag":"code-text","content":["String.prototype.countWords = function() {"]},{"tag":"br","content":null},{"tag":"code-text","content":["  return this.split(\" \").length"]},{"tag":"br","content":null},{"tag":"code-text","content":["};"]},{"tag":"br","content":null},{"tag":"code-text","content":["frase.countWords();"]},{"tag":"br","content":null},{"tag":"code-text","content":["// 4"]},{"tag":"br","content":null},{"tag":"code-text","content":["\"Essa é outra frase qualquer\".countWords();"]},{"tag":"br","content":null},{"tag":"code-text","content":["// 5"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Mas você comprou um livro de Clojure, e não de Ruby ou de JavaScript, então você deve estar curioso para saber como resolvemos isso sem apelar para outras linguagens."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A primeira forma nós já vimos no capítulo "]},{"tag":"ref-label","content":[{"tag":"text","content":["capitulo-funcoes"]}]},{"tag":"text","content":[" e chama-se "]},{"tag":"italic","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["multimethod"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"italic","content":[{"tag":"text","content":["Multimethods"]}]},{"tag":"text","content":[" são legais e bem poderosos, mas fazem uso de "]},{"tag":"italic","content":[{"tag":"text","content":["dynamic dispatching"]}]},{"tag":"text","content":[", decidindo em tempo de execução qual trecho de código vai ser chamado. Ao mesmo tempo que isso aumenta bastante a flexibilidade da linguagem, também acaba nos oferecendo um código relativamente lento."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A outra forma é justamente usando protocolos, como o leitor mais atento já tinha imaginado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Protocolos são, basicamente, um conjunto de métodos e assinaturas sem as respectivas implementações, como se fosse uma interface Java. Inclusive, ao criar um protocolo, uma interface Java é criada internamente contendo todos métodos declarados."]},{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Dispatch, static"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"index","content":[{"tag":"text","content":["Dispatch, compile time"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A grande vantagem dos protocolos em relação aos "]},{"tag":"italic","content":[{"tag":"text","content":["multimethods"]}]},{"tag":"text","content":[" está na velocidade, já que protocolos fazem "]},{"tag":"italic","content":[{"tag":"text","content":["static dispatching"]}]},{"tag":"text","content":[", ou "]},{"tag":"italic","content":[{"tag":"text","content":["compile time dispatch"]}]},{"tag":"text","content":[", que é a decisão em tempo de compilação de qual trecho de código será executado de acordo com o tipo de dado envolvido."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos demonstrar como podemos utilizar polimorfismo com protocolos usando um exemplo do mundo real. Assim nós fugimos do manjado exemplo dos "]},{"tag":"italic","content":[{"tag":"text","content":["cachorros e gatos são animais"]}]},{"tag":"ref-label","content":[{"tag":"text","content":["dominando-js"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Estamos desenvolvendo uma biblioteca de "]},{"tag":"italic","content":[{"tag":"text","content":["log"]}]},{"tag":"text","content":[", onde você pode registrar mensagens conforme o código vai sendo executado. Isso é muito útil para encontrar a causa de problemas na aplicação ou mesmo para entender melhor como ela funciona."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Poderíamos simplesmente usar "]},{"tag":"monospaced","content":[{"tag":"text","content":["println"]}]},{"tag":"text","content":[" para exibir as mensagens, mas queremos algo mais dinâmico. Queremos ter a possibilidade de exibir as mensagens no console, ou gravar as mensagens em um arquivo ou em um banco de dados ou mesmo enviar para um servidor de "]},{"tag":"italic","content":[{"tag":"text","content":["logs"]}]},{"tag":"text","content":[". Tudo isso sem alterar o código que vai ser inspecionado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Um protocolo define apenas a estrutura que o nosso tipo de dados vai ter, sem qualquer detalhe sobre sua implementação."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Existem três formas de implementarmos um protocolo."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["A primeira forma considera que um protocolo é apenas uma interface Java, já que internamente o Clojure vai criar uma interface para o protocolo e utiliza o operador "]},{"tag":"monospaced","content":[{"tag":"text","content":["reify"]}]},{"tag":"text","content":[". Vamos ver esse operador com calma no capítulo "]},{"tag":"ref-label","content":[{"tag":"text","content":["capitulo-integracao-java"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["As duas outras formas são muito parecidas entre si, sendo que uma cria uma estrutura chamada "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" e a outra cria uma estrutura chamada "]},{"tag":"italic","content":[{"tag":"text","content":["type"]}]},{"tag":"text","content":[". A diferença entre ambas é que "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" é imutável e "]},{"tag":"italic","content":[{"tag":"text","content":["type"]}]},{"tag":"text","content":[" não."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos utilizar "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" para os nossos exemplos e deixar "]},{"tag":"italic","content":[{"tag":"text","content":["type"]}]},{"tag":"text","content":[" para o final, apenas para demonstrar como utilizar mutabilidade. Em todo o resto ambos funcionam da mesma forma."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Ao final do capítulo "]},{"tag":"ref-label","content":[{"tag":"text","content":["capitulo-integracao-java"]}]},{"tag":"text","content":[" você vai encontrar um diagrama que ajuda a escolher qual construção será utilizada de acordo com suas necessidades."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Vamos implementar um "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["Loggable"]}]},{"tag":"text","content":[", onde vamos definir quatro níveis de mensagem, de acordo com a gravidade do que queremos registrar."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O nível mais baixo chama-se "]},{"tag":"monospaced","content":[{"tag":"text","content":["debug"]}]},{"tag":"text","content":[", com mensagens utilizadas apenas para depurar, ou "]},{"tag":"italic","content":[{"tag":"text","content":["debugar"]}]},{"tag":"text","content":[", a aplicação. O nível seguinte chama-se "]},{"tag":"monospaced","content":[{"tag":"text","content":["warning"]}]},{"tag":"text","content":[", com mensagens de alerta de que algo pode não estar de acordo com o esperado, como por exemplo uma tentativa de acesso ao sistema sem a devida autenticação."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Em seguida temos "]},{"tag":"monospaced","content":[{"tag":"text","content":["error"]}]},{"tag":"text","content":[", para quando ocorre um erro que pode ser recuperado, como por exemplo um problema na conexão de rede e, finalmente, temos "]},{"tag":"monospaced","content":[{"tag":"text","content":["fatal"]}]},{"tag":"text","content":[", para quando ocorre um erro que não pode ser recuperado, como falta de memória ou algo grave dentro da JVM, e que obriga a aplicação a ser finalizada."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defprotocol Loggable"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (debug   [this message])"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (warning [this message])"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (error   [this message ^Throwable e])"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fatal   [this message ^Throwable e]))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; Loggable"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Cada método de um "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" deve, obrigatoriamente, ter pelo menos um parâmetro que vai armazenar a referência a si mesmo. Imaginando um "]},{"tag":"italic","content":[{"tag":"text","content":["procotol"]}]},{"tag":"text","content":[" como uma interface Java e um "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" ou "]},{"tag":"italic","content":[{"tag":"text","content":["type"]}]},{"tag":"text","content":[" como uma classe, é como se cada método recebesse o objeto "]},{"tag":"monospaced","content":[{"tag":"text","content":["this"]}]},{"tag":"text","content":[" como primeiro parâmetro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Exatamente por conta dessa analogia eu chamei o primeiro parâmetro de cada método de "]},{"tag":"monospaced","content":[{"tag":"text","content":["this"]}]},{"tag":"text","content":[", mas você pode utilizar o nome que for mais conveniente."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Além de "]},{"tag":"monospaced","content":[{"tag":"text","content":["this"]}]},{"tag":"text","content":[", todos os métodos têm um parâmetro por onde você vai poder passar a mensagem a ser exibida. Note que "]},{"tag":"monospaced","content":[{"tag":"text","content":["error"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["fatal"]}]},{"tag":"text","content":[" também têm um parâmetro "]},{"tag":"monospaced","content":[{"tag":"text","content":["e"]}]},{"tag":"text","content":[", que obrigatoriamente deve ser uma implementação de "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.lang.Throwable"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Todos os erros e exceções da JVM são implementações de "]},{"tag":"monospaced","content":[{"tag":"text","content":["java.lang.Throwable"]}]},{"tag":"text","content":[". Isso vai ser útil para que possamos saber exatamente onde ocorreu o erro."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O caracter "]},{"tag":"monospaced","content":[{"tag":"text","content":["^"]}]},{"tag":"text","content":[" na frente de "]},{"tag":"monospaced","content":[{"tag":"text","content":["Throwable"]}]},{"tag":"text","content":[" indica um "]},{"tag":"italic","content":[{"tag":"text","content":["type hint"]}]},{"tag":"text","content":[", que é uma forma de informarmos ao compilador com qual tipo queremos trabalhar ali. Veremos "]},{"tag":"italic","content":[{"tag":"text","content":["type hints"]}]},{"tag":"text","content":[" com calma no capítulo "]},{"tag":"ref","content":[{"tag":"text","content":["capitulo-integracao-java"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos implementar o código da forma mais simples de "]},{"tag":"italic","content":[{"tag":"text","content":["log"]}]},{"tag":"text","content":[", que é aquela que exibe a informação na tela, ou no console, se preferir. Vamos chamar essa implementação de "]},{"tag":"monospaced","content":[{"tag":"text","content":["ConsoleLogger"]}]},{"tag":"text","content":[", que não vai receber nenhuma parâmetro em sua criação.."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(defrecord ConsoleLogger []"]},{"tag":"br","content":null},{"tag":"code-text","content":["  Loggable"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (debug   [this message]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"[DEBUG]\" message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (warning [this message]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"[WARN ]\" message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (error   [this message e]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"[ERROR]\" message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (.printStackTrace e)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["  (fatal   [this message e]"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (println \"[FATAL]\" message)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    (.printStackTrace e)"]},{"tag":"br","content":null},{"tag":"code-text","content":["    message))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; user.ConsoleLogger"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba que em "]},{"tag":"monospaced","content":[{"tag":"text","content":["error"]}]},{"tag":"text","content":[" e "]},{"tag":"monospaced","content":[{"tag":"text","content":["fatal"]}]},{"tag":"text","content":[" nós também exibimos o "]},{"tag":"italic","content":[{"tag":"text","content":["stacktrace"]}]},{"tag":"text","content":[" do erro, que é aquela lista de métodos e funções com os respectivos números de linha exibida sempre que ocorre um erro na execução do código."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Perceba também que todos os nossos métodos retornam a própria mensagem que foi passada como parâmetro. Isso nos permite utilizar o "]},{"tag":"italic","content":[{"tag":"text","content":["log"]}]},{"tag":"text","content":[" dentro de um código sem alterar o resultado."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Agora vamos criar um "]},{"tag":"italic","content":[{"tag":"text","content":["var"]}]},{"tag":"text","content":[" chamado "]},{"tag":"monospaced","content":[{"tag":"text","content":["logger"]}]},{"tag":"text","content":[", que armazenar uma instância de "]},{"tag":"monospaced","content":[{"tag":"text","content":["ConsoleLogger"]}]},{"tag":"text","content":[" e é por onde vamos utilizar nossa ferramenta de "]},{"tag":"italic","content":[{"tag":"text","content":["log"]}]},{"tag":"text","content":["."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Toda vez que você criar um "]},{"tag":"italic","content":[{"tag":"text","content":["record"]}]},{"tag":"text","content":[" ou um "]},{"tag":"italic","content":[{"tag":"text","content":["type"]}]},{"tag":"text","content":[", o Clojure vai te dar uma função iniciada por "]},{"tag":"monospaced","content":[{"tag":"text","content":["->"]}]},{"tag":"text","content":[" que cria o objeto para você. É como se fosse um construtor de uma classe Java."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def logger (->ConsoleLogger))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(debug logger \"Isso é uma mensagem de debug\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [DEBUG] Isso é uma mensagem de debug"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Isso é uma mensagem de debug\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Aqui "]},{"tag":"monospaced","content":[{"tag":"text","content":["debug"]}]},{"tag":"text","content":[" não só exibiu a mensagem de depuração como também retornou o mesmo texto da entrada."]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["O mesmo acontece com os demais métodos."]},{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(warning logger \"Uma mensagem de aviso\")"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [WARN ] Uma mensagem de aviso"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Uma mensagem de aviso\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(error logger \"Agora um erro\" (java.io.FileNotFoundException.))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [ERROR] Agora um erro"]},{"tag":"br","content":null},{"tag":"code-text","content":["; java.io.FileNotFoundException"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at user$eval1137.invoke(NO_SOURCE_FILE:3)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6703)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6692)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6666)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";; mais um monte de chamadas"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"Agora um erro\""]},{"tag":"br","content":null},{"tag":"code-text","content":["(fatal logger \"E aqui o mundo acabou\" (StackOverflowError.)))"]},{"tag":"br","content":null},{"tag":"code-text","content":["; [FATAL] E aqui o mundo acabou"]},{"tag":"br","content":null},{"tag":"code-text","content":["; java.lang.StackOverflowError"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at user$eval1139.invoke(NO_SOURCE_FILE:4)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6703)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6693)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";       at clojure.lang.Compiler.eval(Compiler.java:6666)"]},{"tag":"br","content":null},{"tag":"code-text","content":[";; mais um monte de chamadas"]},{"tag":"br","content":null},{"tag":"code-text","content":["; \"E aqui o mundo acabou\""]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"code","content":["clojure",{"tag":"br","content":null},{"tag":"code-text","content":["(def w (java.io.FileWriter. \"arquivo.log\"))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(.append w (str \"Linha 1\" \\return))"]},{"tag":"br","content":null},{"tag":"code-text","content":["(.flush w)"]},{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"todo","content":[{"tag":"text","content":["continuar daqui"]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"title","content":[{"tag":"text","content":["A seguir..."]}]},{"tag":"paragraph","content":[{"tag":"br","content":null}]},{"tag":"paragraph","content":[{"tag":"text","content":["Apesar das funções serem uma parte muito importante da linguagem, como você deve ter notado pelo tamanho todo deste capítulo, elas não teriam muita utilidade sem as estruturas de dados que a linguagem oferece, e é isso que veremos com detalhes no próximo capítulo."]}]}]}